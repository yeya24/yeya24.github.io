<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>æœèŠ±å¤•æ‹¾</title><link>http://yeya24.github.io/</link><description>Recent content on æœèŠ±å¤•æ‹¾</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Wed, 16 Jun 2021 17:43:54 -0700</lastBuildDate><atom:link href="http://yeya24.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>ç©ç© PolarSignals</title><link>http://yeya24.github.io/post/polar_signals/</link><pubDate>Wed, 16 Jun 2021 17:43:54 -0700</pubDate><guid>http://yeya24.github.io/post/polar_signals/</guid><description>&lt;p>æœ€è¿‘ï¼ŒContinuous Profiling è¿™ä¸ªå¯è§‚æµ‹æ€§ä¸»é¢˜è¶Šæ¥è¶Šå—åˆ°å¤§å®¶çš„å…³æ³¨ï¼Œè¿™ä¸€é¢†åŸŸè›®å¤šæ–°çš„å¼€æºé¡¹ç›®ä¹Ÿå‡ºç°äº†ï¼Œæ¯”å¦‚ &lt;a href="https://github.com/pyroscope-io/pyroscope">Pyroscope&lt;/a>ï¼Œ ä»¥åŠåŸºäº eBPF çš„ &lt;a href="https://github.com/pixie-labs/pixie">pixie&lt;/a> ç­‰ç­‰ã€‚å‡ ä¸ªæœˆå‰æˆ‘ä¹Ÿå†™äº†ä¸€ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº† Conprofï¼Œä¸€ä¸ªåŸºäº Prometheus çš„ Continuous Profiling å·¥å…·ã€‚è€Œ Conprof èƒŒåçš„å…¬å¸ &lt;a href="https://www.polarsignals.com/">PolarSignals&lt;/a>ï¼Œä¹Ÿæ¨å‡ºäº†ä»–ä»¬çš„ SaaS æœåŠ¡ï¼Œç”¨æ¥åš profiles çš„å­˜å‚¨ï¼Œå¯è§†åŒ–ç­‰ç­‰ã€‚å…¶å®ä¸»è¦åŠŸèƒ½è¿˜æ˜¯åŸºäº Conprof æœ¬èº«çš„ APIï¼Œä½†æ˜¯åœ¨ UI çš„æ˜“ç”¨æ€§ä¸Šæ¯”èµ·å¼€æºçš„ç‰ˆæœ¬æœ‰äº†å¾ˆå¤§çš„æå‡ã€‚åœ¨è¿™ç¯‡æ°´æ–‡ä¸­ï¼Œæˆ‘ä¼šç®€å•ä»‹ç»ä¸€ä¸‹ PolarSignals æœ‰å“ªäº›åŠŸèƒ½ã€‚åé¢ä¸ºäº†çœç•¥ï¼Œæˆ‘ä¼šå°† PolarSignals ç®€å†™æˆ PSã€‚ç”±äº PS èƒŒåè¿˜æ˜¯åŸºäºå¼€æºçš„é¡¹ç›®æ„å»ºï¼Œå¦‚æœä½ æƒ³å¼€å‘è‡ªå·±å†…éƒ¨çš„ Continuous Profiling å¹³å°ï¼Œå¯èƒ½æ˜¯ä¸ªä¸é”™çš„å‚è€ƒã€‚&lt;/p>
&lt;h2 id="é…ç½®">é…ç½®&lt;/h2>
&lt;p>&lt;img src="http://yeya24.github.io/img/polar_signals/collect.png" alt="collect">&lt;/p>
&lt;p>PS ä½œä¸ºä¸€ä¸ª SaaS æœåŠ¡ï¼Œéœ€è¦ä½¿ç”¨è€…å…ˆåœ¨è‡ªå·±çš„ç¯å¢ƒä¸­é…ç½®å¥½ Collectorã€‚Collector ä½¿ç”¨ Prometheus æœåŠ¡å‘ç°çš„æ ¼å¼ï¼ŒæŠ“å– profilesï¼Œå†å°†æ•°æ®å†™å…¥åˆ°è¿œç«¯çš„ PS å­˜å‚¨ã€‚&lt;/p>
&lt;h2 id="æŸ¥è¯¢">æŸ¥è¯¢&lt;/h2>
&lt;p>&lt;img src="http://yeya24.github.io/img/polar_signals/ps-query.png" alt="query">&lt;/p>
&lt;p>æŸ¥è¯¢ç•Œé¢ä¸Šï¼Œé¦–å…ˆå·¦ä¾§å¯ä»¥é€‰æ‹© Profile çš„ç±»å‹ã€‚å®é™…ä¸Šï¼Œç±»ä¼¼äº Prometheusï¼ŒProfile çš„ç±»å‹åœ¨è¿™é‡Œå°±æ˜¯ timeseries çš„åå­—ï¼Œç”¨ &lt;code>__name__&lt;/code> è¿™ä¸ªç‰¹æ®Šçš„ label æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚è¯´ä¸‹é¢ä¸¤ä¸ª timeseries æ˜¯ä¸€æ ·çš„ã€‚&lt;/p>
&lt;pre>&lt;code>{__name__=&amp;quot;heap&amp;quot;, app=&amp;quot;test-app&amp;quot;, namespace=&amp;quot;default&amp;quot;}
heap{app=&amp;quot;test-app&amp;quot;, namespace=&amp;quot;default&amp;quot;}
&lt;/code>&lt;/pre>&lt;p>æŸ¥è¯¢æ å³ä¾§å¯ä»¥é€‰æ‹©è¦æŸ¥è¯¢çš„æ—¶é—´èŒƒå›´ï¼Œç›®å‰ PS é»˜è®¤æ˜¯ä¿å­˜ 14 å¤©çš„æ•°æ®ã€‚&lt;/p>
&lt;p>ä¸­é—´çš„è¾“å…¥å¯ä»¥æ¥æŸ¥è¯¢ä¸åŒçš„æ ‡ç­¾ï¼Œä¸è¿‡æ³¨æ„çš„æ˜¯è¿™é‡Œåªèƒ½ç”¨ vector selectorï¼Œä¹Ÿä¸æ”¯æŒ promql çš„ functionsã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/polar_signals/query-heap.png" alt="query-heap">&lt;/p>
&lt;p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æŸ¥è¯¢ heapï¼Œå¹¶æŒ‡å®šä¸€ä¸‹ job labelã€‚ç‚¹å‡» Search button ä¹‹åï¼ŒæŸ¥è¯¢é¦–å…ˆè¿”å›çš„æ˜¯ heap çš„ metricsã€‚åœ¨è¿™é‡Œï¼Œmetrics çš„å€¼æ˜¯ä»ç”¨æˆ·ä¸Šä¼ çš„ pprof æ•°æ®ä¸­å¾—åˆ°çš„ï¼Œå¹¶é€šè¿‡ Prometheus è¿œç¨‹å†™å­˜å‚¨åˆ° PS åç«¯çš„ &lt;a href="https://thanos.io/tip/components/receive.md/">Thanos Receiver&lt;/a> é›†ç¾¤ä¸­ã€‚è¿™ä¹ˆåšï¼Œç›¸å½“äºå¢åŠ äº†ä¸€å±‚ metrics å’Œ profiles çš„ correlationã€‚å› ä¸ºä¸€ä¸ª metric çš„ sample å’Œ profile çš„ sample æœ‰ç€ç›¸åŒçš„æ—¶é—´æˆ³ï¼Œå¹¶ä¸”å®ƒä»¬æ‰€å±çš„æ—¶åºçš„ labels ä¹Ÿä¸€æ ·ï¼Œåªæ˜¯å€¼çš„ç±»å‹ä¸åŒï¼Œåé¢è¦æŸ¥è¯¢å…·ä½“çš„ Profile å¯ä»¥ç›´æ¥é€šè¿‡æ ‡ç­¾ + æ—¶é—´æˆ³æ¥åšç‚¹æŸ¥ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬åœ¨æ’æŸ¥é—®é¢˜æ—¶ï¼Œä» metrics å…¥æ‰‹é€šå¸¸æ›´åŠ ç›´è§‚ã€‚åœ¨ metrics çš„å›¾è¡¨ä¸Šï¼Œå¦‚æœçœ‹åˆ°æœ‰ heap å¼‚å¸¸çš„åœ°æ–¹ï¼Œå•å‡»å¯¹åº”çš„æ—¶åºç‚¹ï¼Œå³å¯è·³è½¬åˆ° profileã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/polar_signals/correlation.png" alt="correlation">&lt;/p>
&lt;p>åœ¨è¿™é‡Œå¯ä»¥å¯¹æ¯” Conprof çš„æŸ¥è¯¢ UIï¼Œä»…ä»…å±•ç¤ºå•ç‹¬æ—¶åºçš„æ ·æœ¬ç‚¹ï¼Œè€Œæ²¡æœ‰å…¶ä»–ä¿¡æ¯ï¼Œé€šå¸¸å¾ˆéš¾æ‰¾åˆ°æœ‰ä»·å€¼çš„ profilesã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/conprof/conprof.png" alt="conprof-ui">&lt;/p>
&lt;p>ç­‰å¾—åˆ°äº†è¦çœ‹çš„ profileï¼Œåé¢è¿›è¡Œå…·ä½“çš„åˆ†ææ—¶ï¼Œå¯ä»¥é‡‡ç”¨ PS æä¾›çš„ View UIï¼ŒåŠŸèƒ½ç±»ä¼¼äº pprof é»˜è®¤çš„ UIï¼Œä½†æ˜¯æ²¡æœ‰é‚£ä¹ˆå…¨ï¼Œæ¯”å¦‚å°±ç¼ºå°‘äº†æœç´¢è¿‡æ»¤çš„åŠŸèƒ½ã€‚ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºçš„æ˜¯ &lt;code>Icicle Graph&lt;/code>ã€‚Ummï¼Œå…¶å®åªæ˜¯ç«ç„°å›¾å€’è¿‡æ¥äº† = =ã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/polar_signals/pprof-ui.png" alt="pprof-ui">&lt;/p>
&lt;h2 id="è¿›é˜¶æŸ¥è¯¢">è¿›é˜¶æŸ¥è¯¢&lt;/h2>
&lt;p>ç›¸æ¯”äºæœ€ç®€å•çš„ç‚¹æŸ¥ï¼ŒPS åœ¨ UI è¿™é‡Œè¿˜æä¾›äº† 2 ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯ Profiles çš„èšåˆå’Œæ¯”è¾ƒã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/polar_signals/merge.png" alt="merge">&lt;/p>
&lt;p>èšåˆè¿™è¾¹æ¯”è¾ƒç®€å•ï¼Œå¯¹äºæ‰€é€‰çš„æ—¶é—´èŒƒå›´ï¼Œæ‰€æœ‰æ»¡è¶³æ‰€é€‰æ‹©æ ‡ç­¾çš„æ—¶é—´åºåˆ—ï¼Œåˆå¹¶ä»–ä»¬çš„ profilesã€‚ç”±äº profiling æ¯æ¬¡çš„é‡‡æ ·å¾—åˆ°çš„ sample ä¸ä¸€å®šèƒ½è¦†ç›–åˆ°ä½ æƒ³è¦çœ‹çš„å‡½æ•°ï¼Œèšåˆå¤šä¸ª samples å¯ä»¥æ›´æ–¹ä¾¿ä½ çš„æŸ¥è¯¢ã€‚ä½ ä¹Ÿå¯ä»¥ç†è§£ä¸ºè¿™æ˜¯ä¸€ç§ downsamplingï¼Œå¯æƒœç›®å‰è¿˜æ˜¯åœ¨æŸ¥è¯¢æ—¶è¿›è¡Œ on-the-fly çš„èšåˆï¼Œæ—¶å»¶è¾ƒé«˜ï¼Œè€Œä¸æ˜¯åƒ Thanos compactor é‚£æ ·çš„ç¦»çº¿é™é‡‡æ ·ã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/polar_signals/compare.png" alt="compare">&lt;/p>
&lt;p>æ¯”è¾ƒçš„ç”¨é€”ä¸€èˆ¬æ¥è¯´æ›´å¹¿ã€‚é€šè¿‡åœ¨å·¦å³ä¸¤ä¾§çš„ metrics è§†å›¾ä¸­é€‰æ‹©ä¸åŒçš„æ—¶é—´ç‚¹ï¼Œå¯¹å¯¹åº”çš„ profiles è¿›è¡Œ diff æ“ä½œã€‚æ¯”å¦‚çº¿ä¸Šçš„æœåŠ¡å‘äº†ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬å‡ºé—®é¢˜äº†ï¼Œé€šè¿‡æ¯”è¾ƒæ–°æ—§ç‰ˆæœ¬çš„ profilesï¼Œå°±èƒ½æ–¹ä¾¿çš„å®šä½åˆ°æ”¹åŠ¨ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†ä¸€ä¸‹ç›®å‰ PS æ‰€æä¾›çš„åŠŸèƒ½ã€‚ç”±äºè¿˜å¤„åœ¨ private beta é˜¶æ®µï¼Œç›®å‰åŠŸèƒ½è¾ƒå°‘ã€‚ä½†æ˜¯ç›¸æ¯”äº Conprof çš„ UIï¼ŒPS åœ¨æ˜“ç”¨æ€§æ–¹é¢è¿˜æ˜¯å¾ˆå‹å¥½çš„ï¼Œæ­¤å¤–ä¹Ÿæä¾›äº† metrics è¿™ä¸€ä¾§çš„é›†æˆï¼Œæ–¹ä¾¿æŸ¥è¯¢ã€‚&lt;/p>
&lt;p>å†ç»™ PolarSignals æ‰“ä¸ªå°å¹¿å‘Šï¼Œé™¤äº†å®ƒçš„ continuous profiling æœåŠ¡ï¼Œå®ƒä»¬ä¹Ÿæä¾›äº† profiles åˆ†äº«çš„&lt;a href="https://share.polarsignals.com/">æœåŠ¡&lt;/a> ã€‚ä½¿ç”¨è€…å¯ä»¥ä¸Šä¼  profileï¼Œåœ¨å®ƒçš„ UI ä¸Šè¿›è¡Œçš„åˆ†æï¼Œç„¶ååˆ†äº«ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ª etcd çš„ &lt;a href="https://github.com/etcd-io/etcd/pull/12919">PR&lt;/a> å°±æ˜¯å¾ˆå¥½çš„ä¾‹å­ã€‚&lt;/p></description></item><item><title>èŠèŠ Conprof å’Œå¯è§‚æµ‹æ€§</title><link>http://yeya24.github.io/post/conprof/</link><pubDate>Fri, 06 Nov 2020 15:24:27 -0500</pubDate><guid>http://yeya24.github.io/post/conprof/</guid><description>&lt;p>&lt;a href="https://research.google/pubs/pub36575/">Google-Wide Profiling: A Continuous Profiling Infrastructure for Data Centers&lt;/a> è®ºæ–‡ä»‹ç»äº† Google å†…éƒ¨çš„ Profilling ç³»ç»Ÿï¼Œç®€ç§° GWPã€‚GWP èƒ½å¤ŸæŒç»­åœ°å¯¹è·¨æ•°æ®ä¸­å¿ƒçš„åŸºç¡€è®¾æ–½è¿›è¡Œ profillingï¼Œè·å–åŒ…æ‹¬äº†æ ˆè°ƒç”¨ï¼Œç¡¬ä»¶äº‹ä»¶ï¼Œå † profileï¼Œå†…æ ¸äº‹ä»¶ç­‰ç­‰ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œåç»­çš„æ•°æ®åˆ†æã€‚å—è¿™ç¯‡è®ºæ–‡å½±å“ï¼ŒConprof æ˜¯ä¸€ä¸ªå¯¹åº”ç”¨ç¨‹åºè¿›è¡ŒæŒç»­ profilling çš„ç³»ç»Ÿã€‚è™½ç„¶ç›®å‰è¿˜ä¸ç®—æˆç†Ÿï¼ŒConprof å·²ç»åœ¨æˆ‘ä»¬ç»„ç”Ÿäº§ç¯å¢ƒçš„é›†ç¾¤ä¸Šç¨³å®šè¿è¡Œäº†å‡ ä¸ªæœˆäº†ï¼Œå¹¶ä¸”èƒ½åœ¨ debug çº¿ä¸Šé›†ç¾¤é—®é¢˜æ–¹é¢æä¾›éå¸¸å¤§çš„å¸®åŠ©ã€‚&lt;/p>
&lt;p>æ®æˆ‘æ‰€çŸ¥ï¼ŒConprof æœ€æ—©äº®ç›¸äº KubeCon EU 2019 çš„ Keynote æ¼”è®²ä¸Šã€‚Conprof çš„ä¸»è¦ä½œè€… Frederic å’Œ Grafana çš„ VP Tom åˆ†äº«äº† Observability çš„æœªæ¥è¶‹åŠ¿ï¼Œå½“æ—¶ä»–ä»¬é¢„æµ‹äº†ä¸‰ç‚¹ã€‚å¾ˆæœ‰è¶£çš„æ˜¯ï¼Œ2020 å¹´åº•è¿™ä¸ªæ—¶é—´èŠ‚ç‚¹å›è¿‡å¤´æ¥çœ‹ï¼Œè¿™ä¸‰ç‚¹åŸºæœ¬å·²ç»æˆä¸ºç°å®ï¼š&lt;/p>
&lt;ul>
&lt;li>More correlation between the three pillars (monitoring, logging and tracing)&lt;/li>
&lt;li>New signals and new analysis&lt;/li>
&lt;li>Rise of index free log aggregation&lt;/li>
&lt;/ul>
&lt;p>å…ˆæ¥èŠèŠç¬¬ä¸‰ç‚¹ã€‚Index free log aggregation çš„æœåŠ¡ï¼Œåœ¨è¿™é‡Œä¸»è¦æŒ‡çš„æ˜¯ Grafana Lokiã€‚ä»¥å¾€æˆ‘ä»¬åœ¨æ—¥å¿—çš„è§£å†³æ–¹æ¡ˆä¸Šé€šå¸¸é‡‡ç”¨ EFK æ¥æ”¶é›†ã€ç´¢å¼•ä»¥åŠæŸ¥è¯¢æ—¥å¿—ï¼Œä½†æ˜¯è¿™çœŸçš„æœ‰å¿…è¦å—ï¼Ÿå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸éœ€è¦å»ºç«‹é‚£ä¹ˆå¤šçš„ç´¢å¼•ï¼Œæˆ‘ä»¬åªéœ€è¦ç±»ä¼¼ grep é‚£æ ·çš„åŠŸèƒ½æ¥å¯¹æ—¥å¿—è¿›è¡ŒæŸ¥è¯¢ã€‚&lt;/p>
&lt;p>å°±è¿™æœ‰äº† Lokiï¼Œå®ƒå¹¶ä¸åƒ ES ä¸€æ ·éœ€è¦ä½ è‡ªå·±ç®¡ç†ç´¢å¼•ï¼Œè€Œæ˜¯é‡‡ç”¨ Prometheus ä¸€æ ·çš„ labels æœºåˆ¶æ¥ç´¢å¼•æ—¥å¿—æ•°æ®ã€‚è¿™æ ·çš„æœºåˆ¶éå¸¸é€‚åˆåœ¨äº‘åŸç”Ÿçš„åœºæ™¯ä¸‹è¿›è¡Œä½¿ç”¨ï¼Œåœ¨ Kubernetes ä¸­ï¼Œæ—¥å¿—é€šå¸¸æ˜¯ä»¥ Cluster, Namespace ä»¥åŠ Pod çš„ç»´åº¦è¿›è¡Œæ”¶é›†å’ŒæŸ¥è¯¢ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹é€šè¿‡è¿™å‡ ä¸ªç®€å•çš„æ ‡ç­¾æˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å®¹å™¨ï¼Œå¹¶é€šè¿‡å†…å®¹è¿‡æ»¤æŸ¥è¯¢æ—¥å¿—ã€‚æ¯ä¸ª Pod çš„ç›‘æ§æŒ‡æ ‡å’Œæ—¥å¿—è¢«ç›¸åŒçš„ labels å…ƒæ•°æ®ä¿¡æ¯ç»™ä¸²è”äº†èµ·æ¥ï¼Œè¿™ä¹Ÿä¸ºåé¢å®ç°å¤šç§å¯è§‚å¯Ÿæ€§æŒ‡æ ‡çš„äº’ç›¸å…³è”æ‰“ä¸‹äº†åŸºç¡€ã€‚&lt;/p>
&lt;p>å†æ¥è¯´ç¬¬ä¸€ç‚¹ï¼Œæ‰“é€šå¯è§‚å¯Ÿæ€§ç›®å‰ä¹Ÿæ˜¯å¾ˆå¤šå…¬å¸æ­£åœ¨åšçš„å·¥ä½œï¼ŒåŒ…æ‹¬äº† Grafanaï¼ŒChronosphere (M3DB èƒŒåçš„å…¬å¸) ä»¥åŠæˆ‘å¸ã€‚åœ¨æ—¥å‰ç»“æŸçš„ ObservabilityCon ä¸Šï¼Œ Grafana æ¼”ç¤ºäº†ä¸€ä¸ª demo æ¥å±•ç¤ºä»–ä»¬å¦‚ä½•æ‰“é€š metricsï¼Œlogsï¼Œtracesã€‚é¦–å…ˆåœ¨æŸ¥è¯¢ Loki çš„æ—¥å¿—ï¼Œå¯¹äºä½¿ç”¨äº† tracing åº“çš„ HTTP è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šå¸¦ä¸Šä¸€ä¸ª traceIDï¼Œå¹¶ä¸”è¿™äº› ID ä¼šè¢«æ‰“å°åœ¨æ—¥å¿—ä¸­ã€‚é€šè¿‡ traceID å¯ä»¥å®šä½åˆ°ä¸€ä¸ªå”¯ä¸€çš„ traceï¼Œ ä»è€Œè·³è½¬åˆ° trace ç³»ç»Ÿçš„ UI è¿›è¡ŒæŸ¥è¯¢ã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/conprof/tempo1.png" alt="trace-log">&lt;/p>
&lt;p>åœ¨ metrics ä¸ trace çš„ç»“åˆä¸Šï¼Œä¸»è¦æ˜¯é‡‡ç”¨ exemplars çš„æœºåˆ¶åœ¨ metrics ä¸­å¸¦ä¸Šé¢å¤–çš„ä¿¡æ¯ã€‚ Exemplar æœ€æ—©è¢«ç”¨åœ¨ Google çš„ StackDriver ä¸­ï¼Œåé¢æˆä¸ºäº† OpenMetrics æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åº”ç”¨é€šè¿‡æ ‡å‡† &lt;code>/metrics&lt;/code> ç«¯å£æš´éœ² metrics æ—¶ï¼Œexemplar ä¿¡æ¯ä¹Ÿä¼šè¢«ä¸€èµ·æš´éœ²ã€‚å¯¹äº Prometheus æ¥è¯´ï¼Œåœ¨å†™è·¯å¾„ä¸Šï¼ŒPrometheus æ”¶é›† metrics çš„æ—¶å€™ä¹Ÿä¼šä¸€å¹¶æ”¶é›† exemplars ä¿¡æ¯ï¼Œå¹¶å­˜å‚¨ä¸‹æ¥ã€‚åœ¨è¯»è·¯å¾„ä¸Šï¼Œä¼šé€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ API æ¥æš´éœ² exemplars ä¿¡æ¯ã€‚&lt;/p>
&lt;pre>&lt;code>$ curl -g 'http://localhost:9090/api/v1/query_exemplar?query=test_exemplar_metric_total&amp;amp;start=2020-09-14T15:22:25.479Z&amp;amp;end=020-09-14T15:23:25.479Z'
{
&amp;quot;status&amp;quot;: &amp;quot;success&amp;quot;,
&amp;quot;data&amp;quot;: [
{
&amp;quot;seriesLabels&amp;quot;: {
&amp;quot;__name__&amp;quot;: &amp;quot;test_exemplar_metric_total&amp;quot;,
&amp;quot;instance&amp;quot;: &amp;quot;localhost:8090&amp;quot;,
&amp;quot;job&amp;quot;: &amp;quot;prometheus&amp;quot;,
&amp;quot;service&amp;quot;: &amp;quot;bar&amp;quot;
},
&amp;quot;exemplars&amp;quot;: [
{
&amp;quot;labels&amp;quot;: {
&amp;quot;traceID&amp;quot;: &amp;quot;EpTxMJ40fUus7aGY&amp;quot;
},
&amp;quot;value&amp;quot;: 6,
&amp;quot;timestamp&amp;quot;: 1600096945479,
&amp;quot;hasTimestamp&amp;quot;: true
}
]
},
]
}
&lt;/code>&lt;/pre>&lt;p>å€Ÿç”¨è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ trace ID ä½œä¸ºä¸€ä¸ª label pair åŠ å…¥ exemplar ä¸­ï¼Œä»è€Œå¯ä»¥ä» Prometheus ä¸­æŸ¥è¯¢åˆ° trace çš„ä¿¡æ¯ï¼Œä»è€Œå°† metrics å’Œ trace è¿æ¥èµ·æ¥ã€‚å½“ç„¶ï¼Œç›®å‰è¿™ä¸ªåŠŸèƒ½è¿˜å¹¶æ²¡æœ‰åˆå¹¶è¿› masterï¼Œå¦‚æœå¯¹ exemplar æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹è¿™ä¸ª &lt;a href="https://github.com/prometheus/prometheus/pull/6635">PR&lt;/a> ã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/conprof/tempo2.png" alt="trace-metrics">&lt;/p>
&lt;h2 id="continous-profilling">Continous Profilling&lt;/h2>
&lt;p>å¥½çš„ï¼Œæ„Ÿè§‰æ‰¯çš„æœ‰ç‚¹è¿œäº†ã€‚æœ€åè®²è®²ä»Šå¤©çš„ä¸»é¢˜ï¼Œç¬¬äºŒç‚¹ä¸­çš„ new signalsï¼ŒæŒ‡çš„å°±æ˜¯ profilesã€‚&lt;/p>
&lt;p>Profiles ç›®å‰å·²ç»è¢«å¹¿æ³›è¿ç”¨ï¼Œä¾‹å¦‚å¼€æºçš„ pprof å·²ç»æ˜¯ Go æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†; å…¶ä»–è¯­è¨€ä¹Ÿæœ‰ pprof çš„å®ç°ï¼Œä¾‹å¦‚ Rust çš„&lt;a href="https://github.com/tikv/pprof-rs">pprof-rs&lt;/a> ã€‚Profiles å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ†æï¼Œè§‚å¯Ÿç¨‹åºçš„è¿è¡Œæ€§èƒ½ï¼ŒåŒ…æ‹¬ CPUï¼Œå†…å­˜ (heap)ï¼Œgoroutine ç­‰ç­‰ã€‚&lt;/p>
&lt;p>ä¸ metrics ç±»ä¼¼ï¼Œpprof ä¹Ÿæ˜¯é€šè¿‡ HTTP ç«¯ç‚¹è¿›è¡Œæš´éœ²ã€‚é‚£ä¹ˆå¦‚æœåƒ Prometheus ä¸€æ ·ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å®šæœŸå»æŠ“å–ç¨‹åºçš„ profiles å¹¶å­˜å‚¨åœ¨ TSDB ä¸­ï¼Œåç»­å‡ºç°é—®é¢˜äº†å†å»æŸ¥è¯¢é‚£ä¸ªæ—¶é—´æ®µçš„ profilesï¼Œå°±èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°å®šä½åˆ°é—®é¢˜ï¼Œå…¶å®è¿™å°±æ˜¯ Conprofã€‚&lt;/p>
&lt;p>Conprof æœ¬è´¨ä¸Šæ˜¯å’Œ Prometheus ä¸€æ ·çš„ç³»ç»Ÿï¼Œå®ƒå¯ä»¥é€šè¿‡ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥è¿è¡Œã€‚ä¸è¿‡ä¸ºäº†æ›´å¥½çš„å¯æ‰©å±•æ€§ï¼Œå®ƒä¹Ÿæ”¯æŒå¾®æœåŠ¡æ¨¡å¼æ¥æ›´å¥½çš„æ”¯æŒæ¨ªå‘æ‰©å±•ã€‚å®ƒå°†å†…éƒ¨çš„ç»„ä»¶åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç»„ä»¶ä¹‹é—´é€šè¿‡ gRPC è¿›è¡Œé€šä¿¡ã€‚ä¸»è¦çš„ç»„ä»¶åŒ…æ‹¬ï¼š&lt;/p>
&lt;ol>
&lt;li>Sampler&lt;/li>
&lt;li>Store&lt;/li>
&lt;li>API&lt;/li>
&lt;/ol>
&lt;p>Sampler æ˜¯æ•°æ®çš„å†™å…¥éƒ¨åˆ†ï¼Œå®ƒåŸºäº Pull æ¨¡å‹ï¼Œç›´æ¥ä½¿ç”¨äº† Prometheus çš„æœåŠ¡å‘ç°æ¨¡å—æ¥å‘ç° targetsï¼Œå®šæœŸå¯¹ä»–ä»¬è¿›è¡Œ Profilingï¼Œå¹¶å°†ç»“æœçš„ protobuf å‹ç¼©åï¼Œé€šè¿‡gRPC API å†™å…¥åˆ° Store ä¸­ã€‚&lt;/p>
&lt;p>Store å°±æ˜¯ä¸€ä¸ª gRPC API å°è£…èµ·æ¥çš„ TSDBã€‚Conprof çš„ TSDB æ˜¯ä¸€ä¸ª fork ç‰ˆæœ¬çš„ Prometheus TSDBã€‚å®ƒä¸ä¸Šæ¸¸çš„ TSDB åŸºæœ¬ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ Conprof ä¸­å­˜å‚¨çš„æ˜¯ protobufï¼Œsample çš„å€¼ç±»å‹æ˜¯ &lt;code>[]byte&lt;/code>, è€Œ Prometheus sample çš„å€¼æ˜¯ &lt;code>float64&lt;/code>ã€‚è¿™å¯¼è‡´äº† Prometheus ä¸­çš„æ•°æ®å¯ä»¥ä½¿ç”¨ &lt;a href="https://www.vldb.org/pvldb/vol8/p1816-teller.pdf">Gorilla paper&lt;/a> ä¸­çš„æ–¹å¼å¯¹æ ·æœ¬è¿›è¡Œ delta-xor å‹ç¼©ï¼Œè€Œ Conprof ä¸è¡Œï¼Œæ‰€ä»¥åœ¨å†…å­˜å’Œç£ç›˜ä½¿ç”¨é‡ä¸Šç›®å‰è¿˜æ˜¯ä¼šé«˜äº Prometheusã€‚&lt;/p>
&lt;p>æœ€åæ˜¯ API ä¹Ÿå°±æ˜¯ Query ç»„ä»¶ã€‚å®ƒå¯¹å¤–æš´éœ²äº†ç±»ä¼¼äº Prometheus çš„ APIï¼ŒåŒ…æ‹¬ &lt;code>query&lt;/code>, &lt;code>label_names&lt;/code>, &lt;code>label_values&lt;/code>, &lt;code>series&lt;/code> ç­‰ç­‰ã€‚å¦å¤–å®ƒä¹ŸåŒ…æ‹¬ä¸€ä¸ªéå¸¸ç®€å•çš„ web UI æ¥æŸ¥è¯¢ profilesï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­è“è‰²çš„å°ç‚¹ä»£è¡¨äº†æ¯ä¸€ä¸ª profile çš„é‡‡æ ·ï¼Œå•å‡»ä¸€ä¸‹å°±å¯ä»¥çœ‹åˆ°å¯¹åº”çš„ pprof UIã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/conprof/conprof.png" alt="conprof">&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/conprof/pprof.png" alt="pprof">&lt;/p>
&lt;p>ä¸è¿‡ç›®å‰æ¥è¯´è¿™ä¸ª UI æ¥å¤„äºéå¸¸åˆçº§çš„é˜¶æ®µï¼Œè€Œä¸”æš‚æ—¶æ²¡åŠæ³•ä¸å…¶ä»–æŒ‡æ ‡è¿›è¡Œé›†æˆã€‚å¦‚æœæƒ³è¦å°† Conprof ä¸ Grafana æ›´å¥½çš„é›†æˆï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ªä¸º Grafana å®ç°çš„ Conprof æ•°æ®æºï¼Œç”¨æ¥åœ¨ Grafanaä¸Šé€šè¿‡ annotations æ¥å±•ç¤º profiles &lt;a href="https://github.com/yeya24/conprof-datasource">https://github.com/yeya24/conprof-datasource&lt;/a> ã€‚&lt;/p>
&lt;h2 id="æœªæ¥">æœªæ¥ï¼Ÿ&lt;/h2>
&lt;h3 id="æ›´çµæ´»çš„æŸ¥è¯¢">æ›´çµæ´»çš„æŸ¥è¯¢&lt;/h3>
&lt;p>ç›®å‰æ¥è¯´ï¼ŒConprof è™½ç„¶å·²ç»èƒ½å¤Ÿæ”¶é›† profilesï¼Œä½†æ˜¯ä»…ä»…åšåˆ°è¿™ä¸€ç‚¹æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„ã€‚å¯¹ç”¨æˆ·æ¥è¯´ï¼ŒUI è¿˜ä¸å¤ªå¥½ç”¨ï¼ŒæŸ¥è¯¢çš„ API ä¹Ÿä¸å¤Ÿçµæ´»ã€‚ç°åœ¨çš„æŸ¥è¯¢ API é™¤äº†è¿”å›åŸºæœ¬çš„å…ƒä¿¡æ¯ï¼Œåªèƒ½è¿”å› pprof çš„ proto æ–‡ä»¶ï¼Œè€Œæ— æ³•ç›´æ¥æŸ¥è¯¢åˆ°ä¾‹å¦‚æŸä¸ªæ—¶é—´çš„ goroutine æ€»æ•°ï¼ŒæŸä¸ªå‡½æ•°çš„è°ƒç”¨æ—¶é—´ç­‰ç­‰æ¯”è¾ƒå…·ä½“çš„å€¼ã€‚&lt;/p>
&lt;h3 id="æ•°æ®åˆ†æ">æ•°æ®åˆ†æ&lt;/h3>
&lt;p>Profilling å’Œ Tracing ç³»ç»Ÿå…¶å®å¾ˆç±»ä¼¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ profile å’Œ trace æ•°æ®æ¥è¿›è¡Œé—®é¢˜çš„å®šä½ï¼Œä½†æ˜¯æˆ‘ä»¬èƒ½å¦ä»è¿™äº›æ•°æ®ä¸­è·å–æ›´æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Ÿ åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿä¸­çš„ Jaeger é¡¹ç›®åœ¨ç›®å‰å‡ºç°äº† OpenTelemetry ä¹‹åï¼Œç›®å‰ä¹ŸæŠŠé‡å¿ƒæ”¾åˆ°äº†åˆ†ææ–¹å‘ï¼Œå¯¹ Jaeger åŠ å…¥ Jupyter Notebookï¼ŒSpark ç­‰å¤šç§ç³»ç»Ÿçš„æ”¯æŒã€‚åŒæ ·æˆ‘æ„Ÿè§‰è¿™ä¹Ÿæ˜¯ Conprof çš„å‘å±•æ–¹å‘ã€‚&lt;/p>
&lt;h3 id="é›†æˆ-metrics-traces-logs">é›†æˆ metrics, traces, logs&lt;/h3>
&lt;p>è¿›è¡Œè¿™æ–¹é¢çš„é›†æˆå¯ä»¥æœ‰ä¸¤ç§æ€è·¯ï¼š&lt;/p>
&lt;ol>
&lt;li>åŸºäº Grafana è¿™ä¸ªå¹³å°ï¼Œå¼€å‘ç»™ pprof çš„ panel æ’ä»¶ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥å±•ç¤ºå‡º profilesã€‚ç”±äº Conprof ä¹Ÿæ˜¯åŸºäº labels çš„ç³»ç»Ÿï¼Œæ‰€ä»¥å¯ä»¥å’Œ Prometheusï¼Œ Loki ç­‰ç³»ç»Ÿè¿›è¡Œè”åŠ¨ã€‚&lt;/li>
&lt;li>åŸºäº Exemplarsï¼Œå‰é¢æåˆ°äº† Exemplars åŒ…å«äº†æ ‡ç­¾å¯¹ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦å°†å•ç‹¬ä¸€ä¸ªç±»ä¼¼äº ID ä¸€æ ·çš„ä¸œè¥¿æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ª profileï¼Œ ç„¶åé€šè¿‡ Exemplar æ¥å°† metrics é“¾æ¥åˆ°å¯¹åº”çš„ profileã€‚&lt;/li>
&lt;/ol>
&lt;h1 id="è”ç³»ä½œè€…">è”ç³»ä½œè€…&lt;/h1>
&lt;p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œæœ‰é”™è¯¯æ¬¢è¿å¤§å®¶æŒ‡å‡ºã€‚å¦‚æœä½ å¯¹äºObservabilityæ„Ÿå…´è¶£ï¼Œæˆ–è€…æ˜¯ä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä½ éƒ½å¯ä»¥è”ç³»æˆ‘ã€‚æˆ‘çš„å¾®ä¿¡æ˜¯ eWJfeGExNAo=ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ &lt;a href="https://github.com/yeya24">Github&lt;/a> ä¸Šæ‰¾åˆ°æˆ‘ã€‚&lt;/p></description></item><item><title>ä½¿ç”¨kubeadmå®‰è£…k8s 1.16.3</title><link>http://yeya24.github.io/post/install-k8s/</link><pubDate>Sat, 06 Apr 2019 16:15:35 +0800</pubDate><guid>http://yeya24.github.io/post/install-k8s/</guid><description>&lt;p>è‡³å°‘ä½¿ç”¨2å°èŠ‚ç‚¹ï¼Œå½“ç„¶æœ€å¥½3å°ï¼Œæ¯å°èµ„æºè¾¾åˆ°4æ ¸8Gï¼Œæ‰€ä½¿ç”¨çš„ç¯å¢ƒåœ¨Centos 7.5ç‰ˆæœ¬åŠä»¥ä¸Š&lt;/p>
&lt;p>äº‹å…ˆå‡†å¤‡ï¼šç»™æ¯å°èŠ‚ç‚¹æ”¹ä¸»æœºåç§°ï¼Œåœ¨k8sä¸­éœ€è¦æ¯ä¸€å°æœºå™¨æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ä¸»æœºåï¼Œåœ¨centosé‡Œé¢ä½¿ç”¨hostnamectlè¿™ä¸ªå·¥å…·æ¥æ›´æ”¹&lt;/p>
&lt;pre>&lt;code>hostnamectl set-hostname xxx
reboot -n # è¿™ä¸€æ­¥æ˜¯é‡å¯
&lt;/code>&lt;/pre>&lt;p>å®‰è£…dockerï¼Œå®‰è£…å®Œæˆä¹‹åè‡ªè¡Œæ£€æŸ¥docker ps æˆ–è€…docker runæ£€æŸ¥å®‰è£…æƒ…å†µ&lt;/p>
&lt;pre>&lt;code>yum update -y
yum install -y yum-utils
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum makecache fast
yum install -y docker-ce
systemctl enable docker
systemctl restart docker
&lt;/code>&lt;/pre>&lt;p>åœ¨æ¯å°æœºå™¨ä¸Šè¿è¡Œä¸‹é¢çš„ä¸€ä¸ªè„šæœ¬ï¼Œå…·ä½“æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªsetting.shæ–‡ä»¶ chmod +x setting.sh å°†è„šæœ¬çš„å†…å®¹å¤åˆ¶è¿›å»ï¼Œåè¿è¡Œè„šæœ¬å³å¯&lt;/p>
&lt;pre>&lt;code>#!/bin/sh
# å…³é—­é˜²ç«å¢™
systemctl stop firewalld &amp;amp;&amp;amp; systemctl disable firewalld
# å…³é—­selinux
setenforce 0
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
# å…³é—­äº¤æ¢åˆ†åŒº
swapoff -a &amp;amp;&amp;amp; sysctl -w vm.swappiness=0
sed '/swap.img/d' -i /etc/fstab
# æ·»åŠ é˜¿é‡Œäº‘çš„k8sæº
cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
# æ·»åŠ éœ€è¦ç”¨åˆ°çš„å†…æ ¸ç½‘ç»œå‚æ•°
cat &amp;lt;&amp;lt;EOF | tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl -p /etc/sysctl.d/k8s.conf
&lt;/code>&lt;/pre>&lt;p>æ¯å°æœºå™¨æ‰§è¡Œå®Œä¸Šé¢çš„è„šæœ¬ä¹‹åï¼Œå†åˆ›å»ºä¸€ä¸ªè„šæœ¬ image.shï¼Œå°†ä»¥ä¸‹å†…å®¹å¤åˆ¶è¿›å»ï¼Œä¹‹å chmod +x image.shè¿™ä¸ªè„šæœ¬ä»¥åå¯ä»¥ç”¨æ¥æ‹‰å–é•œåƒ&lt;/p>
&lt;pre>&lt;code>#!/bin/sh
curl -s https://zhangguanzhang.github.io/bash/pull.sh | bash -s -- $1
&lt;/code>&lt;/pre>&lt;p>æ¥ä¸‹æ¥å¦‚æœæ˜¯masterèŠ‚ç‚¹ï¼Œåˆ›å»ºä¸€ä¸ªinstall-master.shè„šæœ¬å¹¶è¿è¡Œ&lt;/p>
&lt;pre>&lt;code>#!/bin/sh
version=1.16.3
yum install -y kubelet-$version
yum install -y kubectl-$version kubeadm-$version
systemctl enable kubelet
systemctl restart kubelet
cat &amp;lt;&amp;lt;EOF &amp;gt; ~/kubeadm.conf
apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
networking:
podSubnet: &amp;quot;192.168.0.0/16&amp;quot;
kubernetesVersion: &amp;quot;v1.16.3&amp;quot;
EOF
~/image.sh k8s.gcr.io/kube-controller-manager:v$version
~/image.sh k8s.gcr.io/kube-proxy:v$version
~/image.sh k8s.gcr.io/kube-apiserver:v$version
~/image.sh k8s.gcr.io/kube-scheduler:v$version
~/image.sh k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1
~/image.sh k8s.gcr.io/coredns:1.6.2
~/image.sh k8s.gcr.io/etcd:3.3.15-0
~/image.sh k8s.gcr.io/pause:3.1
docker pull calico/node:v3.10.1
docker pull calico/cni:v3.10.1
docker pull calico/kube-controllers:v3.10.1
docker pull calico/pod2daemon-flexvol:v3.10.1
&lt;/code>&lt;/pre>&lt;p>è¿™é‡Œæœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœåˆ›å»ºçš„æœºå™¨åœ¨å…¬æœ‰äº‘ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸Šå…¬æœ‰äº‘æœºå™¨çš„å¼¹æ€§å…¬ç½‘ipï¼Œè¿™æ ·æœ¬åœ°çš„kubectlå°±å¯ä»¥ä¿®æ”¹kubeconfigè®¿é—®åˆ°å…¬æœ‰äº‘masterèŠ‚ç‚¹çš„6443ç«¯å£ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥åœ¨kubeadm.confçš„é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œå¦‚ä¸‹çš„ä¿®æ”¹&lt;/p>
&lt;pre>&lt;code>apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
apiServer:
certSANs:
- è¿™é‡Œå¡«å†™ä½ éœ€è¦æš´éœ²çš„å…¬ç½‘ipåœ°å€
networking:
podSubnet: &amp;quot;192.168.0.0/16&amp;quot;
kubernetesVersion: &amp;quot;v1.16.3&amp;quot;
&lt;/code>&lt;/pre>&lt;p>å¦‚æœæ˜¯nodeï¼Œåˆ›å»ºä¸€ä¸ªinstall-node.shè„šæœ¬å¹¶è¿è¡Œ&lt;/p>
&lt;pre>&lt;code>#!/bin/sh
version=1.16.3
yum install -y kubelet-$version
yum install -y kubeadm-$version
systemctl enable kubelet
systemctl restart kubelet
~/image.sh k8s.gcr.io/kube-proxy:v$version
~/image.sh k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1
~/image.sh k8s.gcr.io/coredns:1.6.2
~/image.sh k8s.gcr.io/pause:3.1
docker pull calico/node:v3.10.1
docker pull calico/cni:v3.10.1
docker pull calico/kube-controllers:v3.10.1
docker pull calico/pod2daemon-flexvol:v3.10.1
&lt;/code>&lt;/pre>&lt;p>ç­‰å¾…æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢çš„è„šæœ¬éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œåœ¨masterèŠ‚ç‚¹ä¸Šè¿è¡Œä¸‹é¢çš„å‘½ä»¤æ­£å¼å¼€å§‹å®‰è£…&lt;/p>
&lt;pre>&lt;code>kubeadm init --config kubeadm.conf
&lt;/code>&lt;/pre>&lt;p>å½“å‡ºç°è¿è¡ŒæˆåŠŸçš„å­—æ ·ä¹‹åï¼Œæ‰§è¡Œå‘½ä»¤&lt;/p>
&lt;pre>&lt;code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
&lt;/code>&lt;/pre>&lt;p>ç„¶ååœ¨nodeèŠ‚ç‚¹ä¸Šé¢æ‰§è¡Œå®‰è£…å®Œæˆåè·³å‡ºæ¥çš„å‘½ä»¤
ä»¥ä¸‹é¢çš„è¿™è¡Œå‘½ä»¤ä¸ºä¾‹ï¼Œåœ¨masterèŠ‚ç‚¹ä¸Šå®‰è£…å®Œæˆä¹‹åä¸‹é¢ä¼šæ˜¾ç¤ºå‡ºç±»ä¼¼çš„è¿™ä¹ˆä¸€æ¡å‘½ä»¤ï¼Œä½ åªè¦å¤åˆ¶ä¸‹æ¥åœ¨nodeèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸‹å³å¯ï¼ˆä¸‹é¢çš„åªæ˜¯ä¸ªç¤ºä¾‹ï¼‰&lt;/p>
&lt;pre>&lt;code>kubeadm join 10.14.10.139:6443 --token zxqopw.kkoe6hduf6113pmn --discovery-token-ca-cert-hash sha256:42de13e61ba1d1647b4f9b21fcf05964b826f84df0db41f87c0b66fb48bb2d32
&lt;/code>&lt;/pre>&lt;p>æœ€åçš„æ­¥éª¤æ˜¯å®‰è£…calicoï¼Œcalicoæ˜¯æˆ‘è¿™è¾¹é€‰æ‹©çš„ç½‘ç»œç»„ä»¶ï¼Œä¸‹é¢çš„å‘½ä»¤éƒ½åœ¨masterä¸Šé¢æ‰§è¡Œ&lt;/p>
&lt;pre>&lt;code>kubectl taint node k8s-m1 node-role.kubernetes.io/master- # è¿™ä¸€æ­¥æ˜¯å»é™¤masterä¸Šé¢çš„æ±¡ç‚¹ï¼Œè¿™ä¸ªåœ°æ–¹è¦æ³¨æ„ï¼Œå°†æˆ‘å‰é¢çš„ k8s-m1 æ¢æˆä½ é‚£è¾¹å¯¹åº”çš„masterèŠ‚ç‚¹çš„åç§°ï¼Œå®é™…æƒ…å†µä¸‹è¿™æ­¥å¯ä»¥ä¸ç”¨æ‰§è¡Œï¼Œéå¿…é¡»ã€‚
wget https://docs.projectcalico.org/v3.10/manifests/calico.yaml
kubectl apply -f calico.yaml
&lt;/code>&lt;/pre>&lt;p>å¯ä»¥é€šè¿‡kubectl get nodes æŸ¥çœ‹çŠ¶æ€ï¼Œä¸€èˆ¬æ¥è¯´å‡ºç°ä¸‹é¢çš„çŠ¶æ€å°±æ˜¯éƒ½okäº†ï¼Œå¦‚æœä¸okï¼Œä¸€èˆ¬æ¥è¯´å¯èƒ½æ˜¯ç½‘ç»œæ’ä»¶è¿˜æ²¡å¯åŠ¨æˆ–è€…è¿è¡Œå‡ºé”™ã€‚&lt;/p>
&lt;pre>&lt;code>NAME STATUS ROLES AGE VERSION
k8s-m1 Ready master 4d23h v1.16.3
k8s-m2 Ready &amp;lt;none&amp;gt; 4d23h v1.16.3
k8s-m3 Ready &amp;lt;none&amp;gt; 4d23h v1.16.3
&lt;/code>&lt;/pre></description></item><item><title>ä½¿ç”¨kindæ¥å¿«é€Ÿéƒ¨ç½²k8sç¯å¢ƒ</title><link>http://yeya24.github.io/post/kind/</link><pubDate>Fri, 05 Apr 2019 10:23:15 +0800</pubDate><guid>http://yeya24.github.io/post/kind/</guid><description>&lt;h2 id="å•¥æ˜¯kind">å•¥æ˜¯kind&lt;/h2>
&lt;p>&lt;a href="https://github.com/kubernetes-sigs/kind">kind&lt;/a> å³ Kubernetes In Dockerï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°† k8s æ‰€éœ€è¦çš„æ‰€æœ‰ç»„ä»¶ï¼Œå…¨éƒ¨éƒ¨ç½²åœ¨ä¸€ä¸ªdockerå®¹å™¨ä¸­ï¼Œæ˜¯ä¸€å¥—å¼€ç®±å³ç”¨çš„ k8s ç¯å¢ƒæ­å»ºæ–¹æ¡ˆã€‚ä½¿ç”¨ kind æ­å»ºçš„é›†ç¾¤æ— æ³•åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœä½ åªæ˜¯æƒ³åœ¨æœ¬åœ°ç®€å•çš„ç©ç© k8sï¼Œä¸æƒ³å ç”¨å¤ªå¤šçš„èµ„æºï¼Œé‚£ä¹ˆä½¿ç”¨ kind æ˜¯ä½ ä¸é”™çš„é€‰æ‹©ã€‚åŒæ ·ï¼Œkind è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¸®ä½ æœ¬åœ°çš„ k8s æºä»£ç æ‰“æˆå¯¹åº”çš„é•œåƒï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨kind">ä½¿ç”¨kind&lt;/h2>
&lt;p>åœ¨å­¦æ ¡çš„ä¸€å° centos ä¸Šç®€å•å°è¯•ä¸€ä¸‹ kindï¼Œå‰ææ˜¯å¿…é¡»è¦å®‰è£…å¥½ docker å’Œ kubectlã€‚&lt;/p>
&lt;pre>&lt;code>wget https://github.com/kubernetes-sigs/kind/releases/download/0.2.1/kind-linux-amd64
mv kind-linux-amd64 kind
chmod +x kind
mv kind /usr/local/bin
&lt;/code>&lt;/pre>&lt;p>å®‰è£…å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ kind æœ‰å“ªäº›å‘½ä»¤ã€‚&lt;/p>
&lt;p>build ç”¨æ¥ä» k8s source æ„å»ºä¸€ä¸ªé•œåƒã€‚&lt;/p>
&lt;p>createã€delete åˆ›å»ºã€åˆ é™¤é›†ç¾¤ã€‚&lt;/p>
&lt;p>export å‘½ä»¤ç›®å‰åªæœ‰ä¸€ä¸ª logs é€‰é¡¹ï¼Œä½œç”¨æ˜¯å°†å†…éƒ¨æ‰€æœ‰å®¹å™¨çš„æ—¥å¿—æ‹·è´åˆ°å®¿ä¸»æœºçš„æŸä¸ªç›®å½•ä¸‹ã€‚&lt;/p>
&lt;p>get æŸ¥çœ‹å½“å‰æœ‰å“ªäº›é›†ç¾¤ï¼Œå“ªäº›èŠ‚ç‚¹ï¼Œä»¥åŠ kubectl é…ç½®æ–‡ä»¶çš„åœ°å€&lt;/p>
&lt;p>load å¯ä»¥ä»å®¿ä¸»æœºå‘ k8s å®¹å™¨å†…å¯¼å…¥é•œåƒã€‚&lt;/p>
&lt;pre>&lt;code>[root@node-2 ~]# kind
kind creates and manages local Kubernetes clusters using Docker container 'nodes'
Usage:
kind [command]
Available Commands:
build Build one of [base-image, node-image]
create Creates one of [cluster]
delete Deletes one of [cluster]
export exports one of [logs]
get Gets one of [clusters, nodes, kubeconfig-path]
help Help about any command
load Loads images into nodes
version prints the kind CLI version
Flags:
-h, --help help for kind
--loglevel string logrus log level [panic, fatal, error, warning, info, debug] (default &amp;quot;warning&amp;quot;)
--version version for kind
Use &amp;quot;kind [command] --help&amp;quot; for more information about a command.
&lt;/code>&lt;/pre>&lt;p>ä¸‹é¢æ¥ä»¥æœ€ç®€å•çš„æ–¹å¼å®‰è£…ä¸€ä¸ªé›†ç¾¤&lt;/p>
&lt;pre>&lt;code>[root@node-2 ~]# kind create cluster
Creating cluster &amp;quot;kind&amp;quot; ...
âœ“ Ensuring node image (kindest/node:v1.13.4) ğŸ–¼
âœ“ Preparing nodes ğŸ“¦
âœ“ Creating kubeadm config ğŸ“œ
âœ“ Starting control-plane ğŸ•¹ï¸
Cluster creation complete. You can now use the cluster with:
export KUBECONFIG=&amp;quot;$(kind get kubeconfig-path --name=&amp;quot;kind&amp;quot;)&amp;quot;
kubectl cluster-info
[root@node-2 ~]# export KUBECONFIG=&amp;quot;$(kind get kubeconfig-path --name=&amp;quot;kind&amp;quot;)&amp;quot;
[root@node-2 ~]# kubectl cluster-info
Kubernetes master is running at https://localhost:39284
KubeDNS is running at https://localhost:39284/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
[root@node-2 ~]# kubectl get node
NAME STATUS ROLES AGE VERSION
kind-control-plane Ready master 99s v1.13.4
&lt;/code>&lt;/pre>&lt;p>ä½¿ç”¨ &lt;strong>kind create cluster&lt;/strong> å®‰è£…ï¼Œæ˜¯æ²¡æœ‰æŒ‡å®šä»»ä½•é…ç½®æ–‡ä»¶çš„å®‰è£…æ–¹å¼ã€‚ä»å®‰è£…æ‰“å°å‡ºçš„è¾“å‡ºæ¥çœ‹ï¼Œåˆ†ä¸º4æ­¥ï¼š&lt;/p>
&lt;ol>
&lt;li>æŸ¥çœ‹æœ¬åœ°ä¸Šæ˜¯å¦å­˜åœ¨ä¸€ä¸ªåŸºç¡€çš„å®‰è£…é•œåƒï¼Œé»˜è®¤æ˜¯ kindest/node:v1.13.4ï¼Œè¿™ä¸ªé•œåƒé‡Œé¢åŒ…å«äº†éœ€è¦å®‰è£…çš„æ‰€æœ‰ä¸œè¥¿ï¼ŒåŒ…æ‹¬äº† kubectlã€kubeadmã€kubelet äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥åŠå®‰è£…å¯¹åº”ç‰ˆæœ¬ k8s æ‰€éœ€è¦çš„é•œåƒï¼Œéƒ½ä»¥ tar å‹ç¼©åŒ…çš„å½¢å¼æ”¾åœ¨é•œåƒå†…çš„ä¸€ä¸ªè·¯å¾„ä¸‹&lt;/li>
&lt;li>å‡†å¤‡ä½ çš„ nodeï¼Œè¿™é‡Œå°±æ˜¯åšä¸€äº›å¯åŠ¨å®¹å™¨ã€è§£å‹é•œåƒä¹‹ç±»çš„å·¥ä½œ&lt;/li>
&lt;li>ç”Ÿæˆå¯¹åº”çš„ kubeadm çš„é…ç½®ï¼Œä¹‹åé€šè¿‡ kubeadm å®‰è£…ï¼Œå®‰è£…ä¹‹åè¿˜ä¼šåšå¦å¤–çš„ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚åƒæˆ‘åˆšæ‰ä»…å®‰è£…å•èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œä¼šå¸®ä½ åˆ æ‰ master èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹ï¼Œå¦åˆ™å¯¹äºæ²¡æœ‰å®¹å¿çš„ pod æ— æ³•éƒ¨ç½²ã€‚&lt;/li>
&lt;li>å¯åŠ¨å®Œæ¯•&lt;/li>
&lt;/ol>
&lt;p>æŸ¥çœ‹å½“å‰é›†ç¾¤çš„è¿è¡Œæƒ…å†µ&lt;/p>
&lt;pre>&lt;code>[root@node-2 ~]# kubectl get po -n kube-system
NAME READY STATUS RESTARTS AGE
coredns-86c58d9df4-6g66f 1/1 Running 0 21m
coredns-86c58d9df4-pqcc4 1/1 Running 0 21m
etcd-kind-control-plane 1/1 Running 0 20m
kube-apiserver-kind-control-plane 1/1 Running 0 20m
kube-controller-manager-kind-control-plane 1/1 Running 0 20m
kube-proxy-cjgnt 1/1 Running 0 21m
kube-scheduler-kind-control-plane 1/1 Running 0 21m
weave-net-ls2v8 2/2 Running 1 21m
&lt;/code>&lt;/pre>&lt;p>é»˜è®¤æ–¹å¼å¯åŠ¨çš„èŠ‚ç‚¹ç±»å‹æ˜¯ control-plane ç±»å‹ï¼ŒåŒ…å«äº†æ‰€æœ‰çš„ç»„ä»¶ã€‚åŒ…æ‹¬2 * corednsã€etcdã€api-serverã€controller-managerã€kube-proxyã€shedulerï¼Œç½‘ç»œæ’ä»¶æ–¹é¢é»˜è®¤ä½¿ç”¨çš„æ˜¯ weaveï¼Œä¸”ç›®å‰åªæ”¯æŒ weaveï¼Œä¸æ”¯æŒå…¶ä»–é…ç½®ï¼Œå¦‚æœéœ€è¦å¯ä»¥ä¿®æ”¹ kind ä»£ç è¿›è¡Œå®šåˆ¶ã€‚&lt;/p>
&lt;p>åŸºæœ¬ä¸Šï¼Œkind çš„æ‰€æœ‰ç§˜å¯†éƒ½åœ¨é‚£ä¸ªåŸºç¡€é•œåƒä¸­ã€‚ä¸‹é¢æ˜¯åŸºç¡€å®¹å™¨å†…éƒ¨çš„ /kind ç›®å½•ï¼Œåœ¨ bin ç›®å½•ä¸‹å®‰è£…äº† kubeletã€kubeadmã€kubectl è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œimages ä¸‹é¢æ˜¯é•œåƒçš„ tar åŒ…ï¼Œkind åœ¨å¯åŠ¨åŸºç¡€é•œåƒåä¼šæ‰§è¡Œä¸€é docker load æ“ä½œå°†è¿™äº› tar åŒ…å¯¼å…¥ã€‚manifests ä¸‹é¢æ˜¯ weave çš„ cniã€‚&lt;/p>
&lt;pre>&lt;code>root@kind-control-plane:/kind# ls
bin images kubeadm.conf manifests systemd version
root@kind-control-plane:/kind# ls bin/
kubeadm kubectl kubelet
root@kind-control-plane:/kind# ls images/
4.tar 6.tar 8.tar kube-controller-manager.tar kube-scheduler.tar
5.tar 7.tar kube-apiserver.tar kube-proxy.tar
root@kind-control-plane:/kind# ls manifests/
default-cni.yaml
root@kind-control-plane:/kind# ls systemd/
10-kubeadm.conf kubelet.service
&lt;/code>&lt;/pre>&lt;h2 id="åˆ›å»ºå¤šèŠ‚ç‚¹çš„é›†ç¾¤">åˆ›å»ºå¤šèŠ‚ç‚¹çš„é›†ç¾¤&lt;/h2>
&lt;p>é»˜è®¤å®‰è£…çš„é›†ç¾¤åªå¸¦ä¸Šäº†ä¸€ä¸ªæ§åˆ¶èŠ‚ç‚¹ï¼Œä¸‹é¢é‡æ–°åˆ›å»ºä¸€ä¸ªä¸¤èŠ‚ç‚¹çš„é›†ç¾¤ã€‚é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼Œåœ¨ node ä¸­å¯ä»¥é…ç½®çš„ä¸æ˜¯å¾ˆå¤šï¼Œé™¤äº† role å¦å¤–çš„å¯ä»¥æ›´æ”¹ node ä½¿ç”¨çš„é•œåƒï¼Œä¸è¿‡æˆ‘è¿™è¾¹è¿˜æ˜¯ä½¿ç”¨é»˜è®¤çš„é•œåƒã€‚&lt;/p>
&lt;pre>&lt;code>apiVersion: kind.sigs.k8s.io/v1alpha3
kind: Cluster
nodes:
- role: control-plane
- role: worker
&lt;/code>&lt;/pre>&lt;p>è¿˜æ˜¯ä½¿ç”¨å‘½ä»¤å®‰è£…&lt;/p>
&lt;pre>&lt;code>[root@node-2 ~]# kind create cluster --config=kind-config.yaml
Creating cluster &amp;quot;kind&amp;quot; ...
âœ“ Ensuring node image (kindest/node:v1.13.4) ğŸ–¼
âœ“ Preparing nodes ğŸ“¦ğŸ“¦
âœ“ Creating kubeadm config ğŸ“œ
âœ“ Starting control-plane ğŸ•¹ï¸
âœ“ Joining worker nodes ğŸšœ
Cluster creation complete. You can now use the cluster with:
export KUBECONFIG=&amp;quot;$(kind get kubeconfig-path --name=&amp;quot;kind&amp;quot;)&amp;quot;
kubectl cluster-info
[root@node-2 ~]# kubectl get nodes
NAME STATUS ROLES AGE VERSION
kind-control-plane Ready master 3m20s v1.13.4
kind-worker Ready &amp;lt;none&amp;gt; 3m8s v1.13.4
[root@node-2 ~]# kubectl get po -n kube-system
NAME READY STATUS RESTARTS AGE
coredns-86c58d9df4-cnqhc 1/1 Running 0 5m29s
coredns-86c58d9df4-hn9mv 1/1 Running 0 5m29s
etcd-kind-control-plane 1/1 Running 0 4m24s
kube-apiserver-kind-control-plane 1/1 Running 0 4m17s
kube-controller-manager-kind-control-plane 1/1 Running 0 4m21s
kube-proxy-8t4xt 1/1 Running 0 5m27s
kube-proxy-skd5v 1/1 Running 0 5m29s
kube-scheduler-kind-control-plane 1/1 Running 0 4m18s
weave-net-nmfq2 2/2 Running 1 5m27s
weave-net-srdfw 2/2 Running 0 5m29s
&lt;/code>&lt;/pre>&lt;p>å¤§åŠŸå‘Šæˆï¼Œä¸€å¥—æµ‹è¯•é›†ç¾¤å¾ˆè½»æ¾å°±æ­å»ºå®Œæˆå•¦ã€‚&lt;/p></description></item><item><title>GSoC 2019ä¸­çš„Prometheusç›¸å…³é¡¹ç›®ä»‹ç»</title><link>http://yeya24.github.io/post/gsoc-prometheus-2019/</link><pubDate>Sun, 03 Mar 2019 13:34:50 +0800</pubDate><guid>http://yeya24.github.io/post/gsoc-prometheus-2019/</guid><description>&lt;p>ä¸­å›½æ—¶é—´3æœˆ1å·å‡Œæ™¨ï¼Œcncf å…¬å¸ƒäº†2019å¹´ GSoC é¡¹ç›®çš„ ideaï¼Œå…·ä½“çš„Githubåœ°å€åœ¨ &lt;a href="https://github.com/cncf/soc">cncf/soc&lt;/a>ã€‚&lt;/p>
&lt;p>ç®€å•çœ‹äº†ä¸€ä¸‹é‡Œé¢çš„ä¸€äº›é¡¹ç›®ï¼Œåœ¨ k8s çš„é¡¹ç›®ä¸­ï¼Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ kube-batch è¿™ä¸ªè°ƒåº¦å™¨ä¸ pytorch-operator/mxnet-operator çš„æ•´åˆï¼Œè¿™ä¹Ÿæ˜¯ä¸ªä¸ kubeflow ç´§å¯†ç›¸å…³çš„é¡¹ç›®ã€‚é™¤æ­¤ä»¥å¤–çš„ idea å¾ˆå¤šä¸ k8s çš„ CSI ä»¥åŠ dashboard ç›¸å…³ã€‚åœ¨ Prometheus çš„ idea ä¸­ï¼Œæ„Ÿè§‰æ•´ä½“çš„æœ‰è¶£ç¨‹åº¦å¹¶ä¸åŠå»å¹´ï¼Œä¸è¿‡ä»Šå¹´ cortex ä¹Ÿæˆä¸ºäº† cncf çš„æ²™ç®±é¡¹ç›®ï¼Œæ‰€ä»¥å¯¹ Prometheus æ„Ÿå…´è¶£çš„åŒå­¦ä¹Ÿå¯ä»¥é€‰æ‹©å»å°è¯•å®Œæˆ cortex çš„é¡¹ç›®ã€‚ä¸€ç›´éƒ½å¯¹ Prometheus æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œè¿™ç¯‡æ–‡ç« çš„ä¸»è¦å†…å®¹å°±æ˜¯æ¥ä»‹ç»ä¸€ä¸‹19å¹´ GSoC é‡Œé¢ä¸ Prometheus ç›¸å…³çš„ idea ã€‚&lt;/p>
&lt;h1 id="prometheus">Prometheus&lt;/h1>
&lt;p>Prometheus æ˜¯ä¸€ä¸ªå¼€æºçš„ç›‘æ§æŠ¥è­¦ç³»ç»Ÿã€‚å…·ä½“ä¿¡æ¯è¯·å‚è€ƒå®˜ç½‘ï¼š&lt;a href="https://prometheus.io/">https://prometheus.io/&lt;/a>&lt;/p>
&lt;h2 id="benchmarks-for-tsdb">Benchmarks for TSDB&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Krasi Georgiev&lt;/li>
&lt;li>æŠ€èƒ½: CI, Golang, Kubernetes&lt;/li>
&lt;/ul>
&lt;p>TSDB æ˜¯ Prometheus åº•ä¸‹çš„æ—¶åºæ•°æ®åº“ï¼Œè¢«æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„ repo ä¸­ï¼Œé“¾æ¥åœ¨ &lt;a href="https://github.com/prometheus/tsdb">prometheus/tsdb&lt;/a>ã€‚ç®€è€Œè¨€ä¹‹å°±æ˜¯ä¸º TSDB å†™ä¸€ä¸ª benchmarkï¼Œä¸ Prombench é¡¹ç›®ç±»ä¼¼ã€‚&lt;/p>
&lt;h2 id="continue-the-work-on-prombench">Continue the work on Prombench&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Krasi Georgiev&lt;/li>
&lt;li>æŠ€èƒ½: CI, Golang, Kubernetes, Grafana&lt;/li>
&lt;/ul>
&lt;p>Prombench æ˜¯18å¹´çš„ GSoC é¡¹ç›®ï¼ŒåŒ…æ‹¬äº† Prometheus çš„å·¥ä½œæµä¸­ä¸€æ•´å¥—çš„ benchmarksï¼ˆä¸åŒ…æ‹¬ TSDBï¼‰ã€‚ ä»Šå¹´çš„å·¥ä½œæ˜¯ä¿®å¤é¡¹ç›®ç›®å‰çš„ä¸€äº›å¯æ‰©å±•æ€§çš„é—®é¢˜ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¸®å¿™ä¿® bug å’Œåšä¸€äº›æ‰©å±•ã€‚ä¸»è¦å‚è€ƒè¯¥ repo ä¸‹é¢çš„ &lt;a href="https://github.com/prometheus/prombench/issues">issues&lt;/a> ï¼Œä¼˜å…ˆä¿®å¤é«˜ä¼˜å…ˆçº§çš„ issueï¼Œæ„Ÿè§‰å°±æ˜¯å»æ¬ç –ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚&lt;/p>
&lt;h2 id="persist-retroactive-rule-reevaluations">Persist Retroactive Rule Reevaluations&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Ganesh Vernekar (@codesome), Goutham Veeramachaneni (@gouthamve)&lt;/li>
&lt;li>æŠ€èƒ½: Golang&lt;/li>
&lt;/ul>
&lt;p>åœ¨ Prometheus ç›®å‰çš„ recording rule ä¸­ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜å°±æ˜¯ï¼Œä¸€å®šè¦è¿™ä¸ª recording rule æ‰§è¡Œä¹‹åï¼ŒTSDB é‡Œé¢æ‰ä¼šå‡ºç°è¿™ä¸ª metricã€‚æ¯”å¦‚åœ¨ Grafana ä¸­æ ¹æ®è¿™ä¸ª metric ç”»å›¾ï¼Œä¸€å¼€å§‹çš„ä¸€æ®µæ—¶é—´ä½ æ˜¯çœ‹ä¸åˆ°æ•°æ®çš„ï¼Œå› ä¸ºæ•°æ®å¾ˆå°‘ï¼ˆä¸€æ¬¡ evaluation çš„è¿‡ç¨‹ç”Ÿæˆä¸€ä¸ª metricï¼‰ã€‚è¿™ä¸ª idea çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§£å†³æ‹¿ä¸åˆ°æ•°æ®çš„é—®é¢˜ï¼Œå»å¯¹æ—§çš„æ•°æ®è¿›è¡ŒæŸ¥è¯¢æ¥å¾—åˆ°è¿™ä¸ªæŒ‡å®šçš„ metricï¼Œä½¿åœ¨ Grafana é‡Œé¢èƒ½çœ‹åˆ°æ•°æ®ã€‚å¦å¤–ï¼Œç”Ÿæˆçš„ metrics è¦æ±‚åœ¨ TSDB ä¸­æŒä¹…åŒ–ä¸€æ®µæ—¶é—´ã€‚ï¼ˆä¸çŸ¥é“æˆ‘æœ‰æ²¡æœ‰ç†è§£é”™æ„æ€ï¼Œå¦‚æœæœ‰è¯¯è¯·æŒ‡æ­£ï¼‰&lt;/p>
&lt;p>è¿™æ˜¯æ¯”è¾ƒè€çš„ä¸€ä¸ª issue äº†ï¼Œç›¸å¯¹æ¥è¯´æˆ‘ä¹Ÿæ„Ÿè§‰ä¸æ˜¯å¾ˆé«˜çš„ä¼˜å…ˆçº§ã€‚ä¸çŸ¥é“å»å¹´æ²¡å®Œæˆçš„ä¸€äº› idea ä»Šå¹´ä¸ºå•¥ä¸æäº†ï¼Œæ¯”å¦‚åœ¨ Prometheus ä¸­æ”¯æŒæ…¢æŸ¥è¯¢æˆ‘è§‰å¾—å°±è›®æœ‰æ„ä¹‰çš„ã€‚&lt;/p>
&lt;p>å‚è€ƒåœ°å€ï¼š&lt;a href="https://github.com/prometheus/prometheus/issues/11">Persist Retroactive Rule Reevaluations&lt;/a>&lt;/p>
&lt;h2 id="optimize-queries-using-regex-matchers-for-set-lookups">Optimize queries using regex matchers for set lookups&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Goutham Veeramachaneni (@gouthamve)&lt;/li>
&lt;li>æŠ€èƒ½: Golang&lt;/li>
&lt;/ul>
&lt;p>é€šè¿‡ Prometheus æŸ¥è¯¢æ—¶åºæ•°æ®ï¼Œé€šè¿‡æ­£åˆ™åŒ¹é… labels æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°éœ€è¦åŒæ—¶åŒ¹é…å¤šä¸ªå€¼çš„æƒ…å†µï¼Œåœ¨ Grafana ä¸­è¿™ç§ case å°¤ä¸ºå¸¸è§ã€‚è€Œç›®å‰åœ¨Prometheus çš„ TSDB ä¸­ï¼Œå¯¹äºæ­£åˆ™åŒ¹é…çš„ matcher å®ƒçš„å¤„ç†è¿‡ç¨‹æ˜¯æ‹¿åˆ°éœ€è¦æŸ¥è¯¢çš„ label çš„æ‰€æœ‰çš„ valueï¼Œç„¶åä¾æ¬¡è¿›è¡Œæ­£åˆ™åŒ¹é…æ¥ç­›é€‰ï¼Œå¾ˆæœ‰å¯èƒ½å‡ºç°æ•ˆç‡é—®é¢˜ï¼Œè€Œè¿™ä¸ª idea çš„ç›®çš„å°±æ˜¯å¯¹è¿™ç§æ­£åˆ™åŒ¹é…è¿›è¡Œä¼˜åŒ–ã€‚æ¯”å¦‚è¯´&lt;code>up{instance=~&amp;quot;foo|bar|baz&amp;quot;}&lt;/code>ï¼Œå¦‚æœéœ€è¦ä¼˜åŒ–å¯ä»¥å°†è¿™ç§æ­£åˆ™åŒ¹é…è½¬æ¢æˆå¯¹ TSDB çš„ä¸‰æ¬¡æŸ¥è¯¢ï¼Œå˜æˆ &lt;code>up{instance=&amp;quot;foo&amp;quot;}&lt;/code>ã€&lt;code>up{instance=&amp;quot;bar&amp;quot;}&lt;/code>ã€&lt;code>up{instance=&amp;quot;baz&amp;quot;}&lt;/code>ï¼Œä¹‹åå†å°†æŸ¥è¯¢å¾—åˆ°çš„ timeseries è¿›è¡Œèšåˆã€‚å½“ç„¶è¿™ä¹Ÿåªæ˜¯ä½œè€…ç»™å‡ºçš„ä¸€ä¸ªç¤ºä¾‹ï¼Œå®é™…ä¸Šæƒ³åšæˆä»€ä¹ˆæ ·å­å¯ä»¥è‡ªå·±å®ç°ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ª &lt;a href="https://github.com/prometheus/prometheus/issues/2651">issue&lt;/a> ä¸­ä½œè€…ä¹Ÿç»™å‡ºäº† 2 ä¸ªå®ç°çš„ä¸»è¦æ€è·¯ï¼š&lt;/p>
&lt;ul>
&lt;li>é€šè¿‡ TSDB è‡ªèº«æ¥å®ç°ä¼˜åŒ–ï¼Œæˆ‘è®¤ä¸ºè¿™ä¹Ÿæ˜¯æ¯”è¾ƒåˆç†çš„ä¸€ç§ï¼Œé’ˆå¯¹ matcher å¤„ç†åº”è¯¥æ˜¯ TSDB æœ¬èº«çš„èƒ½åŠ›ã€‚&lt;/li>
&lt;li>åœ¨ Prometheus å±‚é¢å®ç°ä¸€ä¸ªæŸ¥è¯¢ä¼˜åŒ–å™¨ï¼Œå¯ä»¥ç®€å•çš„ç±»æ¯”äº MySQL é‡Œé¢çš„ SQL Optimizerã€‚ç”¨æˆ·è¿›è¡Œ promql æŸ¥è¯¢ä¹‹å‰ï¼Œå¯¹ç”¨æˆ·è¾“å…¥çš„è¡¨è¾¾å¼è¿›è¡Œä¼˜åŒ–ã€‚ç±»ä¼¼äºè¿™ç§ &lt;code>rate(requests{instance=~&amp;quot;foo|bar&amp;quot;}[1m])&lt;/code>ï¼Œå¯ä»¥è½¬åŒ–æˆ &lt;code>rate(requests{instance=&amp;quot;foo&amp;quot;}[1m]) OR rate(requests{instance=&amp;quot;bar&amp;quot;}[1m])&lt;/code>ï¼Œå°†æ­£åˆ™åŒ¹é…ä¸­çš„æˆ–è½¬åŒ–æˆäº† promql é‡Œçš„ orã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸ª idea çš„è¯åº”è¯¥æ¯”è¾ƒç†æƒ³çš„å®ç°æ–¹å¼æ˜¯ç¬¬ä¸€ç§ï¼ŒTSDB çš„ä»£ç ä¸å¤šï¼Œæ¶‰åŠæŸ¥è¯¢çš„é‚£ä¸€éƒ¨åˆ†çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒæ¸…æ¥šï¼Œä¸è¿‡è¿™ä¸ªå° feature ä¼˜å…ˆçº§ä¸é«˜ï¼Œä¹Ÿä¸æ¶‰åŠ Prometheus çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œæ›´å¤šæ˜¯å¯¹äº Grafana æŸ¥è¯¢ Prometheus è¿™ä¸ª case ä¸‹æä¾›çš„ä¸€ç§ä¼˜åŒ–ã€‚&lt;/p>
&lt;h2 id="package-for-bulk-imports">Package for bulk imports&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Ganesh Vernekar (@codesome)&lt;/li>
&lt;li>æŠ€èƒ½: Golang&lt;/li>
&lt;/ul>
&lt;p>æ„Ÿè§‰æ˜¯ä»Šå¹´çš„ idea é‡Œé¢æœ€æœ‰ç”¨çš„ä¸€ä¸ª feature äº†ï¼Œä¸è¿‡æ„Ÿè§‰åšèµ·æ¥ä¹Ÿæ¯”è¾ƒè´¹åŠ›ï¼Œç›®çš„ä¸»è¦æ˜¯ä¸º Prometheus å®ç°æ•°æ®æ‰¹é‡ä¸Šä¼ çš„ APIã€‚ä¸Šä¼ çš„æ•°æ®åŒ…æ‹¬ Prometheus çš„æ•°æ®ä»¥åŠé Prometheus çš„æ•°æ®ï¼ˆå¦‚ OpenTSDBã€Influxdbï¼‰ã€‚è¿™ä¸ª idea æœ‰å¾ˆå¤§çš„ usecaseï¼š&lt;/p>
&lt;ul>
&lt;li>å®ç°äº†æ‰¹é‡ä¸Šä¼ ä¹‹åï¼Œå¯ä»¥è¯´æ›´æ–¹ä¾¿åš backup äº†ã€‚ç›‘æ§çš„ metrics æ•°æ®å¯ä»¥å¦å¤–åšå¤‡ä»½ï¼Œéœ€è¦æ—¶å¯ä»¥é€šè¿‡è¯¸å¦‚ promtool é€šè¿‡æ‰¹é‡å¯¼å…¥çš„ API å°†æ•°æ®è½½å…¥ Prometheusï¼Œæœ‰ç‚¹åƒ etcdctl çš„ backupã€restoreã€‚&lt;/li>
&lt;li>æ›´åŠ æ–¹ä¾¿åšæµ‹è¯•ã€‚æ¯”å¦‚ä½ éœ€è¦å¾—åˆ°ä¸€äº›ç”Ÿäº§ä¸­çš„ metricsï¼Œç„¶åæ ¹æ®å®ƒä»¬æ¥å†™ä¸€äº›æŠ¥è­¦è§„åˆ™æˆ–è€…æµ‹è¯• Grafana çš„ dashboardã€‚ä¸è¿‡ä½ åªæœ‰ä½ æœ¬åœ°çš„ PC çš„ç¯å¢ƒï¼Œæ²¡åŠæ³•å»è¿ç”Ÿäº§ç¯å¢ƒçš„ Prometheusï¼Œé‚£ä¹ˆæ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿå¦‚æœæœ‰æ‰¹é‡å¯¼å…¥æ•°æ®å¯ä»¥å¾ˆè½»æ¾çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚&lt;/li>
&lt;li>æ›´åŠ æ–¹ä¾¿å…¶ä»–ç›‘æ§ç³»ç»Ÿçš„ç”¨æˆ·è½¬å‘ Promethuesã€‚å¦‚æœä½ ä»¥å‰é‡‡ç”¨çš„æ˜¯æŸä¸ªç›‘æ§ç³»ç»Ÿï¼Œæ¯”å¦‚ Influxdbã€OpenTSDBï¼Œå¦‚æœä½ æƒ³è½¬è€Œé‡‡ç”¨ Prometheusï¼Œé‚£ä¹ˆå¯¹ä¸èµ·ä¸€åˆ‡ä»é›¶å¼€å§‹ã€‚å¦‚æœæ‰¹é‡ä¸Šä¼ çš„ API èƒ½å¤Ÿå¯¹æ¥å…¶ä»–ç³»ç»Ÿçš„æ•°æ®çš„è¯ï¼Œé‚£è¿ç§»å…¶å®å°±éå¸¸æ–¹ä¾¿äº†ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸ª idea å·¥ä½œé‡æ„Ÿè§‰è¿˜æ˜¯è›®å¤§çš„ï¼Œç›®å‰çš„æƒ…å†µä¸‹åœ¨ TSDB é‚£è¾¹åˆšåˆš merge äº†ä¸€ä¸ª vertical querier çš„å®ç°ï¼Œèƒ½å¤Ÿæ”¯æŒè¯»å–æ—¶åºæœ‰è¦†ç›–çš„æ•°æ®å—é‡Œé¢çš„æ•°æ®ï¼Œæœ‰äº†è¿™ä¸ª featureï¼Œç¨å¾®å‡å°‘äº†ä¸€äº›å·¥ä½œé‡ã€‚å€¼å¾—ä¸€æçš„æ˜¯ mentor å°å“¥ Ganesh å¯¹äºæ—¶åºæ•°æ®åº“éå¸¸çš„äº†è§£ï¼Œä¸º Prometheus å’Œ TSDB è´¡çŒ®äº†å¤šä¸ªå¤§ featureï¼Œå¦‚æœæœ‰ä»–åš mentor çš„è¯åº”è¯¥è¿˜æ˜¯èƒ½å­¦åˆ°ä¸å°‘ä¸œè¥¿çš„ã€‚&lt;/p>
&lt;p>å‚è€ƒ issue:&lt;br>
&lt;a href="https://github.com/prometheus/prometheus/issues/535">bulk input&lt;/a>ã€
&lt;a href="https://github.com/prometheus/tsdb/pull/370">vertical querier&lt;/a>&lt;/p>
&lt;h1 id="linkerd2">Linkerd2&lt;/h1>
&lt;p>Linkerd2 æ˜¯ä¸€ç§ ServiceMeshï¼Œé¡¹ç›®åŸç”Ÿå°±æä¾›äº†ç‹‚æ‹½é…·ç‚«åŠç‚¸å¤©çš„ Prometheus å’Œ Grafana é›†æˆã€‚&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/gsoc-2019/linkerd-web.png" alt="linkerd-web">&lt;/p>
&lt;p>&lt;img src="http://yeya24.github.io/img/gsoc-2019/linkerd-grafana.png" alt="linkerd-Grafana">&lt;/p>
&lt;h2 id="alertmanager-integration">Alertmanager Integration&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Thomas Rampelberg (@grampelberg)&lt;/li>
&lt;li>æŠ€èƒ½: Go, Prometheus, Grafana, Kubernetes&lt;/li>
&lt;/ul>
&lt;p>Linkerd ç›®å‰è™½ç„¶å·²ç»é›†æˆäº† Prometheus å’Œ Grafanaï¼Œä½†ç›®å‰å¹¶æ²¡æœ‰é…ç½®é»˜è®¤çš„å‘Šè­¦è§„åˆ™ï¼Œå½“ç„¶ä¹Ÿæ²¡æœ‰ä½¿ç”¨ Alertmanagerã€‚è¿™ä¸ª idea ä¸»è¦æ˜¯åŸºäº Alertmanager ä¸º linkerd å®ç°å¼€ç®±å³ç”¨çš„å‘Šè­¦èƒ½åŠ›ã€‚å…·ä½“è¦æ±‚å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>Alertmanager ä½œä¸ºä¸€ä¸ªå®‰è£…æ—¶çš„å¯é€‰é¡¹ã€‚&lt;/li>
&lt;li>ä¸ºæ§åˆ¶å¹³é¢è®¾ç½®é»˜è®¤çš„å‘Šè­¦è§„åˆ™ã€‚&lt;/li>
&lt;li>ä½¿ç”¨è€…èƒ½å¤Ÿå¾ˆè½»æ¾çš„é…ç½®å‘Šè­¦çš„å‘é€ã€‚æåˆ°çš„å‘Šè­¦æ–¹å¼åŒ…æ‹¬ slack å’Œ emailï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯ Alertmanagerã€€åŸç”Ÿæ”¯æŒçš„ã€‚&lt;/li>
&lt;li>é€šè¿‡ linkerd ä¸­çš„ ServiceProfile(Linkerd ä¸­çš„ä¸€ç§ CRD) æ¥æ”¯æŒå¯¹æŸæœåŠ¡é…ç½®å‘Šè­¦è§„åˆ™ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ•´ä½“æ¥è¯´éš¾åº¦ä¹Ÿä¸å¤§ï¼Œæ¯”è¾ƒæœ‰è¶£ã€‚å¦‚æœæœ¬èº«å¯¹ ServiceMesh æ¯”è¾ƒæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è€ƒè™‘å‚åŠ ã€‚&lt;/p>
&lt;h1 id="cortex">Cortex&lt;/h1>
&lt;p>Cortex æ˜¯åŸºäº Prometheus è¿›è¡Œæ‰©å±•çš„ä¸€ä¸ªé¡¹ç›®ï¼Œåœ°å€åœ¨&lt;a href="https://github.com/cortexproject/cortex">cortexproject/cortex&lt;/a>ã€‚åœ¨ä¹‹å‰ä¸¤å±Šçš„ PromCon ä¸­éƒ½å¯¹è¿™ä¸ªé¡¹ç›®æœ‰æ‰€ä»‹ç»ï¼Œç›®å‰ä¹Ÿæˆä¸ºäº† cncf çš„æ²™ç®±é¡¹ç›®ã€‚Cortex çš„ä¸»è¦ç›®çš„æ˜¯å®ç°æ”¯æŒå¤šç§Ÿæˆ·ã€å¯æ°´å¹³æ‰©å±•çš„ Prometheusï¼Œå¦å¤–å®ƒä¹Ÿæä¾› metrics çš„é•¿æœŸå­˜å‚¨ã€‚Cortex ä¸€ç›´ä»¥æ¥éƒ½è¿è¡Œäº Grafana Cloud å’Œ Weave Cloud ä¸­ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ç§ Prometheus-as-a-Service çš„æœåŠ¡ã€‚åœ¨Weave Cloud ä¸­æœ‰ä¸€ä¸ªå«åš Prometheus-book çš„ä¸œä¸œï¼Œå¬èµ·æ¥è·Ÿ Jupyter-Notebook å·®ä¸å¤šï¼ŒåŠŸèƒ½ä¸Šç¡®å®ç±»ä¼¼ã€‚å®ƒç»™æ¯ä¸ªç”¨æˆ·æä¾›äº†ä¸€ä¸ª Prometheus çš„ç•Œé¢ï¼Œæ¯ä¸ªç§Ÿæˆ·çš„ metrics æ•°æ®éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œç”¨æˆ·å¯ä»¥åœ¨ Prometheus-book ä¸­æŸ¥è¯¢è‡ªå·±çš„ metricsã€‚æ—¢ç„¶æ˜¯è¿™æ ·è‡ªç„¶éœ€è¦ç§Ÿæˆ·é—´æ•°æ®éš”ç¦»ä»¥åŠæ•°æ®é•¿æœŸå­˜å‚¨ï¼Œæä¾›è¿™ç§èƒ½åŠ›çš„å°±æ˜¯ Cortexã€‚Cortex é¡¹ç›®ç›®å‰è´¡çŒ®è€…ä¸å¤šï¼Œå¦‚æœè§‰å¾— Prometheus é¡¹ç›®è´¡çŒ®çš„é—¨æ§›æ¯”è¾ƒé«˜ï¼Œç«äº‰æ¯”è¾ƒæ¿€çƒˆï¼ˆä¸‰å“¥ä»¬å®åœ¨æ˜¯å¤ªçŒ›äº†ï¼‰ï¼Œå¯ä»¥è€ƒè™‘å‚åŠ è¿™ä¸ªé¡¹ç›®ã€‚&lt;/p>
&lt;p>å¦å¤–ç”±äºå¯¹ Cortex ç›¸å…³çš„ä»£ç å®ç°è¿˜æ²¡æ€ä¹ˆçœ‹å®Œï¼Œæ‰€ä»¥ä¸‹é¢éƒ¨åˆ†å†…å®¹æ˜¯å‡­ç€å®˜æ–¹çš„æ¶æ„ã€æ–‡æ¡£ä»¥åŠä¸€äº› issue é‡Œé¢çš„è®¨è®ºå†™çš„ï¼Œæœ‰é”™è¯¯è¯·æŒ‡æ­£ã€‚&lt;/p>
&lt;h2 id="improve-ingester-handover">Improve Ingester Handover&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Bryan Boreham (@bboreham)&lt;/li>
&lt;li>æŠ€èƒ½: Go&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://github.com/cortexproject/cortex/blob/master/docs/architecture.png?raw=true" alt="Architecture">&lt;/p>
&lt;p>åœ¨ Cortex ç›®å‰çš„æ¶æ„ä¸­ï¼Œå¤§éƒ¨åˆ†çš„ç»„ä»¶éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œé™¤äº† Ingestor æ˜¯æœ‰çŠ¶æ€çš„ï¼ˆé‡Œé¢éœ€è¦ä¿å­˜ä¸€å®šæ—¶é—´å†…çš„ Prometheus çš„ metricsï¼‰ã€‚Prometheus é€šè¿‡ remote write API å‘ Cortex å†™æ•°æ®ï¼Œæ•°æ®ç‚¹é€šè¿‡ Distributor åˆ†å‘åˆ° Ingesterï¼Œå…·ä½“çš„åˆ†å‘æ–¹å¼ä½¿ç”¨çš„æ˜¯ DHTï¼ˆåˆ†å¸ƒå¼å“ˆå¸Œè¡¨ï¼‰ã€‚å½“å‰çš„å®ç°ä¸­ï¼ŒDistributor é‡Œé¢ä¿å­˜çš„ IngesterPool ä»…ä»…å…è®¸æ¯12å°æ—¶ä¼¸ç¼©1ä¸ªIngestorï¼Œå¯æ‰©å±•æ€§æ–¹é¢é—®é¢˜æ¯”è¾ƒå¤§ã€‚è‡³äºä¸ºä»€ä¹ˆæ˜¯12å°æ—¶æ˜¯å› ä¸º Ingester ä¼šä¸€ç›´ä¿å­˜12ä¸ªå°æ—¶ Prometheus çš„ metricsï¼Œå¦‚æœå‡ºç°ç›¸åŒçš„ series å°±å¯¹å®ƒä»¬è¿›è¡Œå‹ç¼©ï¼Œ12å°æ—¶åˆ°äº†å†åˆ·åˆ°åç«¯çš„å¯¹è±¡å­˜å‚¨ä¸­å»ï¼Œè¿™æ ·å­åšçš„è¯æ¯”è¾ƒä¸å¥½åº”å¯¹æµé‡è´Ÿè½½åŠ¨æ€å˜åŒ–çš„æƒ…å†µã€‚&lt;/p>
&lt;p>æ€»ç»“ä¸€ä¸‹è¿™ä¸ª idea å°±æ˜¯å¯¹ Distributor æ¥æ”¶åˆ°æ•°æ®åˆ†å‘ -&amp;gt; Ingester å¤„ç† -&amp;gt; ä¸€å®šæ—¶é—´åˆ·åˆ°å¯¹è±¡å­˜å‚¨é‡Œé¢å»ï¼Œè¿™ä¸€æ•´ä¸ªæµç¨‹è¿›è¡Œä¼˜åŒ–æˆ–è€…é‡æ„ä½¿è¿™ä¸ªæ¶æ„å˜å¾—æ˜“äºæ‰©å±•ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒåŒæ ·æ˜¯ Grafana çš„ loki åœ¨è¿™éƒ¨åˆ†çš„æ¶æ„ä¼¼ä¹å’Œ Cortex ä¸€è‡´ï¼Œå¦‚æœä½ å®Œæˆäº†è¿™è¾¹çš„ issueï¼Œä¹Ÿå¯ä»¥å»ç»™ loki æ PR äº†ï¼šï¼‰ã€‚&lt;/p>
&lt;h2 id="centralized-rate-limiting">Centralized Rate Limiting&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Bryan Boreham (@bboreham)&lt;/li>
&lt;li>æŠ€èƒ½: Go&lt;/li>
&lt;/ul>
&lt;p>Cortex æ˜¯ä¸€ä¸ªå…¸å‹çš„å¾®æœåŠ¡æ¶æ„ï¼Œæ¯ä¸ªç»„ä»¶å„è‡ªéƒ½å®ç°äº†é™æµã€‚ä¸è¿‡å½“éœ€è¦ç”¨æˆ·å¯¹distributor/ingester è¿›è¡Œæ‰©å±•æ—¶ï¼Œå°±ä¼šå—åˆ°é™åˆ¶ï¼ˆï¼Ÿè¿™é‡Œæ²¡æ€ä¹ˆçœ‹æ‡‚ï¼‰ã€‚æœ€å¥½èƒ½å¤Ÿå®ç°å…¨å±€çš„é™æµèƒ½åŠ›ï¼Œè¿™æ ·åŒæ ·ä¹Ÿèƒ½ç®€åŒ–é…ç½®ã€‚å‚è€ƒé“¾æ¥åœ¨ï¼š&lt;a href="https://github.com/cortexproject/cortex/issues/1090">issues/1090&lt;/a>ã€‚åœ¨é“¾æ¥ä¸­è¿˜æåˆ°äº† youtube å¼€æºçš„ doormanï¼Œdoorman é€šè¿‡åç«¯çš„ä¸€è‡´æ€§å­˜å‚¨æ¥å®ç°å…¨å±€çš„é™æµã€‚ç›¸å…³çš„å†…å®¹æˆ‘ä¸æ˜¯å¾ˆäº†è§£ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œå‚è€ƒã€‚&lt;/p>
&lt;h2 id="use-etcd-in-cortex">Use etcd in Cortex&lt;/h2>
&lt;ul>
&lt;li>å¯¼å¸ˆ: Bryan Boreham (@bboreham)&lt;/li>
&lt;li>æŠ€èƒ½: Go&lt;/li>
&lt;/ul>
&lt;p>å½“å‰çš„ Cortex ä¸­ä½¿ç”¨ consul å­˜å‚¨ä¸€äº›é›†ç¾¤çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ rulerã€ingesterã€querier ç­‰ç»„ä»¶éƒ½éœ€è¦å»æŸ¥è¯¢ consul ä¸­çš„ä¿¡æ¯ã€‚è¿™ä¸ª idea çš„ä¸»è¦ä»»åŠ¡æ˜¯ä¸ºå­˜å‚¨çŠ¶æ€æä¾›å¯é€‰çš„ etcd æ”¯æŒï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒå®¹æ˜“ã€‚å¦å¤–åœ¨ Cortex çš„ issue ä¸­æˆ‘ä¹Ÿçœ‹åˆ°æœ‰äººæè®®æ”¯æŒ tikvï¼Œå¦‚æœæ—¶é—´å……è£•ä¹Ÿå¯ä»¥ä¸€èµ·å®ç°äº† ï¼šï¼‰ã€‚&lt;/p>
&lt;h1 id="è”ç³»ä½œè€…">è”ç³»ä½œè€…&lt;/h1>
&lt;p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œæœ‰é”™è¯¯æ¬¢è¿å¤§å®¶æŒ‡å‡ºã€‚å¦‚æœä½ å¯¹äºä»Šå¹´çš„è¿™äº›é¡¹ç›®æˆ–æ˜¯å¯¹äº Prometheus æˆ–æ˜¯ Kubernetes æ„Ÿå…´è¶£ï¼Œæˆ–è€…æ˜¯ä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä½ éƒ½å¯ä»¥è”ç³»æˆ‘ã€‚æˆ‘çš„å¾®ä¿¡æ˜¯ eWJfeGExNAo=ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ &lt;a href="https://github.com/yeya24">Github&lt;/a> ä¸Šæ‰¾åˆ°æˆ‘ã€‚&lt;/p></description></item><item><title>influxdbçš„é«˜å¯ç”¨æ–¹æ¡ˆ</title><link>http://yeya24.github.io/post/influxdb_ha/</link><pubDate>Sat, 02 Mar 2019 22:32:12 +0800</pubDate><guid>http://yeya24.github.io/post/influxdb_ha/</guid><description>&lt;p>ç”±äºç›®å‰influxdbæœ¬èº«çš„é›†ç¾¤æ–¹æ¡ˆå±äºé—­æºçŠ¶æ€ï¼Œè€Œæœ¬èº«çš„influxdbå¹¶ä¸æ”¯æŒé›†ç¾¤ã€‚åœ¨ç›®å‰çš„ç¤¾åŒºä¸­å‡ºç°çš„æ–¹æ¡ˆä¸»è¦æœ‰ä¸¤ç§ï¼š&lt;/p>
&lt;ul>
&lt;li>influxdb-relayã€€è¿™æ˜¯å®˜æ–¹æä¾›çš„é«˜å¯ç”¨æ–¹æ¡ˆï¼Œå·²ç»æœ‰ï¼’å¹´æ²¡æœ‰æ›´æ–°äº†ï¼Œç›®å‰æœ‰ä¸€ä¸ªå®˜æ–¹çš„forkè¿˜åœ¨æ´»è·ƒ&lt;/li>
&lt;li>influx-proxyã€€é¥¿äº†å—çš„å¼€æºçš„æ–¹æ¡ˆï¼Œå¤§æ¦‚æ˜¯åœ¨influxdb-relayçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¿®æ”¹&lt;/li>
&lt;/ul>
&lt;h2 id="influxdb-relay">influxdb-relay&lt;/h2>
&lt;p>è¿™é‡Œä¸»è¦è®²ä¸€ä¸‹ç›®å‰æ´»è·ƒçš„relayçš„forkï¼Œgithubåœ°å€åœ¨&lt;a href="https://github.com/vente-privee/influxdb-relay">influxdb-relay&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://imgchr.com/i/kqtEdI">&lt;img src="https://s2.ax1x.com/2019/03/02/kqtEdI.png" alt="kqtEdI.png">&lt;/a>&lt;/p>
&lt;p>forkç‰ˆæœ¬çš„relayä¸åŸç‰ˆåŠŸèƒ½æ¯”è¾ƒç±»ä¼¼ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªhttpserverï¼Œæ”¶åˆ°å†™è¯·æ±‚åèƒ½å¤Ÿæ”¯æŒé€šè¿‡httpæˆ–è€…udpæ–¹å¼å‘influxdbå†™å…¥æ•°æ®ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥æ”¯æŒprometheusçš„è¿œç¨‹å†™å…¥(http)ã€‚ä¸è¿‡ä¸è¶³çš„æ˜¯ï¼Œrelayå¹¶ä¸æ”¯æŒinfluxdbçš„æŸ¥è¯¢æ¥å£ï¼Œä¹Ÿä¸æ”¯æŒprometheusçš„è¿œç¨‹è¯»ã€‚&lt;/p>
&lt;p>å½“æ•°æ®å†™å…¥çš„è¯·æ±‚åˆ°è¾¾relayè¿™ä¸€å±‚ï¼Œrelayä¼šå¯¹è‡ªå·±é…ç½®çš„åç«¯çš„influxdbå‘èµ·å†™è¯·æ±‚ï¼Œä¸è¿‡è¿™é‡Œå¹¶æ²¡æœ‰èƒ½å¤Ÿè§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚å¦‚æœå†™å…¥influxdbæ—¶å¤±è´¥ï¼Œåˆ™åªä¼šç®€å•çš„è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œå†™å…¥å¤±è´¥çš„æ•°æ®å°±åœ¨è¿™ä¸€ä¸ªinfluxdbä¸­ä¸¢å¤±äº†ã€‚&lt;/p>
&lt;h2 id="influx-proxy">influx-proxy&lt;/h2>
&lt;p>influx-proxy æ˜¯é¥¿äº†å—å¼€æºçš„æ–¹æ¡ˆã€‚githubåœ°å€åœ¨&lt;a href="https://github.com/shell909090/influx-proxy">influx-proxy&lt;/a>ã€‚&lt;/p>
&lt;p>&lt;a href="https://imgchr.com/i/kqtAeA">&lt;img src="https://s2.ax1x.com/2019/03/02/kqtAeA.png" alt="kqtAeA.png">&lt;/a>&lt;/p>
&lt;p>ä¸Šé¢æ˜¯proxyç»™å‡ºçš„ä¸€ä¸ªæ¶æ„å›¾ã€‚å¯ä»¥çœ‹å‡ºproxyç»„ä»¶åŒæ—¶æ”¯æŒå¤–é¢çš„æŸ¥è¯¢å’Œå†™å…¥è¯·æ±‚ã€‚å½“proxyæ”¶åˆ°æ•°æ®å‘influxdbå†™å…¥åªæ”¯æŒhttpçš„æ–¹å¼ã€‚åœ¨proxyå’Œinfluxdbä¸­é—´å¤šäº†ä¸€ä¸ªä¸­é—´å±‚ï¼Œåœ¨è¿™ä¸ªä¸­é—´å±‚å¯ä»¥å¯¹å†™å…¥æ•°æ®è¿›è¡Œåˆ†ç‰‡ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„measurementï¼ˆåœ¨prometheusä¸­ç§°ä¸ºmetricï¼‰ï¼Œé…ç½®å®ƒä»¬å‘é€åˆ°ç‰¹å®šçš„åç«¯influxdbã€‚&lt;/p>
&lt;p>proxyçš„æ¶æ„ä¸­åŒ…å«äº†redisã€‚ä¸€å¼€å§‹ä»¥ä¸ºredisæ˜¯ç”¨æ¥è§£å†³relayä¸­æ²¡æœ‰è§£å†³çš„æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå½“å†™å…¥å¤±è´¥ä¹‹åï¼Œå°†æ•°æ®å­˜å…¥redisç¼“å­˜ï¼Œåé¢å†å†™ï¼Œåé¢å‘ç°proxyå¹¶æ²¡æœ‰è¿™ä¹ˆä½¿ç”¨redisã€‚redisåœ¨å…¶ä¸­çš„ä½œç”¨ä»…ä»…æ˜¯å­˜å‚¨proxyçš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬å­˜å‚¨åˆ†ç‰‡é…ç½®ï¼Œinfluxdbåç«¯çš„åœ°å€ã€ä½¿ç”¨çš„æ•°æ®åº“ã€è¶…æ—¶æ—¶é—´ç­‰ç­‰ã€‚proxyä¹Ÿæä¾›äº†ä¸€ä¸ª reload çš„çƒ­åŠ è½½çš„æ¥å£ï¼Œçƒ­åŠ è½½æ—¶ä¼šå»è¯»å–redisä¸­çš„é…ç½®ç„¶åé‡æ–°å¯åŠ¨åç«¯æœåŠ¡ï¼Œredisåªæ˜¯ç”¨æ¥å¹²è¿™ä»¶äº‹æƒ…çš„ã€‚å¦‚æœåªæ˜¯ç”¨äºåŠ è½½é…ç½®ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸é‡‡ç”¨ç®€å•çš„æ–‡ä»¶æ–¹å¼è€Œè¦ä½¿ç”¨redisã€‚&lt;/p>
&lt;p>proxyçš„å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œè§£å†³äº†ä¹‹å‰relayçš„å†™å…¥ä¸€è‡´æ€§é—®é¢˜ã€‚åœ¨proxyå¯åŠ¨ä¹‹åï¼Œè¯»å–é…ç½®ä¸­åç«¯çš„influxdbï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªåç«¯ç”Ÿæˆä¸€ä¸ªæ•°æ®æ–‡ä»¶å’Œä¸€ä¸ªå…ƒæ•°æ®æ–‡ä»¶ã€‚å½“é€šè¿‡httpæ¥å£å†™å…¥æ•°æ®æ—¶ï¼Œproxyä¼šå‘ç¬¦åˆåˆ†ç‰‡é…ç½®çš„æ‰€æœ‰influxdbå®ä¾‹è¿›è¡Œå†™å…¥ï¼Œå¦‚æœå‘æŸä¸ªdbå†™å…¥æˆåŠŸï¼Œåˆ™è¿”å›ï¼›è‹¥å¤±è´¥ï¼Œåˆ™å°†éœ€è¦å†™å…¥çš„æ•°æ®å†™åˆ°è¯¥dbå¯¹åº”çš„æ•°æ®æ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;p>æœ‰å¦å¤–ä¸€ä¸ªgoroutineä¼šå»æŸ¥çœ‹æ•°æ®æ–‡ä»¶ï¼Œå‘ç°æ•°æ®æ–‡ä»¶ä¸­æœ‰æ•°æ®ï¼Œåˆ™ä¼šå†å¯¹è¯¥influxdbå°è¯•å†™å…¥ã€‚å¦‚æœæ­¤æ¬¡å†™å…¥æˆåŠŸï¼Œåˆ™åˆ é™¤åˆšåˆšå†™è¿›å»çš„è¿™æ¡æ•°æ®ã€‚å¦‚æœå†™å…¥å¤±è´¥ï¼Œåˆ™å¯¹æ•°æ®æ–‡ä»¶è¿›è¡Œå›æ»šæ“ä½œã€‚å…·ä½“çš„å›æ»šæ“ä½œéœ€è¦ç”¨åˆ°å…ƒæ•°æ®æ–‡ä»¶ï¼Œåœ¨æ¯æ¬¡åå°çš„goroutineå‘ç°æ•°æ®æ–‡ä»¶æœ‰æ–‡ä»¶éœ€è¦å†™å…¥å‰ï¼Œä¼šå°†æœ¬æ¬¡è¦å†™å…¥çš„æ•°æ®å…ˆå†™è¿›å…ƒæ•°æ®æ–‡ä»¶ï¼Œä¹‹åå°è¯•å†™influxdbï¼Œè‹¥å¤±è´¥ï¼Œåˆ™å°†æ•°æ®æ–‡ä»¶é‡Œçš„æ–‡ä»¶åç§»(offset)å›å¤åˆ°ä¹‹å‰çš„ä½ç½®(æ ¹æ®å…ƒæ•°æ®æ–‡ä»¶é‡Œçš„ä¿¡æ¯åˆ¤æ–­é•¿åº¦)ã€‚&lt;/p>
&lt;p>ä¸è¿‡å¾ˆå¥‡æ€ªçš„ä¸€ç‚¹æ˜¯ï¼Œä¸Šé¢æ‰€è¯´çš„è¿™ä¸ªåå°goroutineåªæœ‰åœ¨åŠ è½½é…ç½®çš„æ—¶å€™æ‰ä¼šå¯åŠ¨ä¸€æ¬¡ï¼Œè¿è¡Œå®Œå°±ç»“æŸã€‚åŠ è½½é…ç½®åªæœ‰åœ¨proxyå¯åŠ¨æˆ–è€…è°ƒç”¨reloadæ¥å£æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯ä¸€ç›´åœ¨åå°è¿è¡Œï¼Œè¿™ä¸€ç‚¹çœŸçš„è®©äººå¾ˆéš¾ç†è§£ã€‚æ­¤å¤–ï¼Œé‡‡ç”¨æ–‡ä»¶æ¥ä¿å­˜å†™å…¥å¤±è´¥çš„æ•°æ®çš„è¿™ä¸€åšæ³•ä¼šæ¶ˆè€—å¤§é‡çš„ç£ç›˜ioï¼Œæ€§èƒ½å—åˆ°æ¯”è¾ƒå¤§çš„å½±å“ï¼Œè¿˜éœ€è¦æ‰¿å—æ–‡ä»¶ç³»ç»ŸæŸåçš„é£é™©ã€‚&lt;/p></description></item><item><title>P4è¯­è¨€ä»‹ç»</title><link>http://yeya24.github.io/post/p4/</link><pubDate>Mon, 25 Feb 2019 10:24:05 +0800</pubDate><guid>http://yeya24.github.io/post/p4/</guid><description>&lt;p>å‰è¨€ï¼šè¿™ç¯‡æ–‡ç« å‚è€ƒè‡ªSDNLABä¸Šzenhoxçš„&lt;a href="https://www.sdnlab.com/22466.html">P4ç¼–ç¨‹ç†è®ºä¸å®è·µâ€”â€”ç†è®ºç¯‡&lt;/a>ï¼Œä»¥åŠæ¨æ³½å«ã€æå‘ˆè€å¸ˆçš„&amp;laquo;é‡æ„ç½‘ç»œä¸SDN&amp;raquo;ä¸€ä¹¦ï¼Œåœ¨è¿™é‡Œå¯¹ä»–ä»¬è¡¨ç¤ºèƒ½å†™å‡ºéå¸¸é«˜è´¨é‡çš„SDNæ–‡ç« ä¹Ÿè¡¨ç¤ºè¡·å¿ƒçš„æ„Ÿè°¢ã€‚&lt;/p>
&lt;p>åœ¨SDNä¸­ï¼Œä¸€ä¸ªé‡è¦çš„æ¦‚å¿µå°±æ˜¯æ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢çš„åˆ†ç¦»ã€‚æ§åˆ¶å¹³é¢å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æ§åˆ¶å™¨ï¼Œå¦‚æœé‡‡ç”¨openflowåè®®ï¼Œæ•°æ®å¹³é¢å°±æ˜¯æ”¯æŒopenflowçš„äº¤æ¢æœºã€‚æ§åˆ¶å¹³é¢ä¸æ•°æ®å¹³é¢ä¹‹é—´ä»…èƒ½é€šè¿‡openflowåè®®è¿›è¡Œé€šè®¯ã€‚openflowåè®®æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>é¢„å…ˆå®šä¹‰å¥½çš„æ§åˆ¶å™¨ä¸æ•°æ®å¹³é¢è®¾å¤‡ä¹‹é—´é€šä¿¡çš„æŠ¥æ–‡æ ¼å¼&lt;/li>
&lt;li>openflowæ˜¯ä¸€ç§ç‹­ä¹‰çš„å—å‘åè®®ï¼Œæ˜¯åè®®ç›¸å…³çš„ï¼Œæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢éƒ½éœ€è¦å®ç°è¯¥åè®®ã€‚&lt;/li>
&lt;/ul>
&lt;p>è™½ç„¶openflowä¸ºSDNå¥ å®šäº†åŸºç¡€ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œopenflowè¿˜å­˜åœ¨ç€æ¯”è¾ƒå¤§çš„å±€é™ã€‚å®ƒæ— æ³•åšåˆ°åè®®ä¸ç›¸å…³ï¼Œç”±äºå¿…é¡»éµå¾ªopenflowåè®®æ¥è¿›è¡Œç¼–ç¨‹ï¼Œè€Œæ— æ³•æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œé¢å¤–æ‰©å±•ï¼Œå¾ˆä¸çµæ´»ã€‚openflowåªèƒ½åœ¨å·²ç»å›ºåŒ–çš„äº¤æ¢æœºæ•°æ®å¤„ç†é€»è¾‘ä¸Šï¼Œé€šè¿‡æµè¡¨ã€ç»„è¡¨ç­‰æŒ‡å¯¼æ•°æ®æµå¤„ç†ï¼Œå´æ— æ³•é‡æ–°å®šä¹‰äº¤æ¢æœºå¤„ç†æ•°æ®çš„é€»è¾‘ã€‚æ­¤å¤–ï¼Œåœ¨openflowçš„ç‰ˆæœ¬è¿­ä»£é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œå­—æ®µçš„å˜åŒ–ä¹Ÿéå¸¸å¤šã€‚åœ¨openflow 1.0ç‰ˆæœ¬ä¸­ä»…æ”¯æŒ12ä¸ªåŒ¹é…å­—æ®µï¼Œ1.3ç‰ˆæœ¬ä¸­æ”¯æŒ40ä¸ªåŒ¹é…å­—æ®µï¼Œåˆ°äº†1.5ç‰ˆæœ¬åˆ™å¯ä»¥æ”¯æŒ45ä¸ªåŒ¹é…å­—æ®µã€‚éšç€ç‰ˆæœ¬çš„æ›´è¿­éœ€è¦å¯¹å­—æ®µè¿›è¡Œæ›´æ”¹ï¼Œå¦‚æœæ˜¯è½¯ä»¶å±‚é¢çš„æ§åˆ¶å™¨å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„ä¿®æ”¹ï¼Œä½†æ˜¯å¯¹äºæ•°æ®å¹³é¢ï¼Œç‰¹åˆ«æ˜¯æ”¯æŒopenflowçš„ç¡¬ä»¶äº¤æ¢æœºæ¥è¯´ï¼Œæ¯æ¬¡ä¿®æ”¹åè®®éƒ½éœ€è¦é‡æ–°ç¼–å†™æ•°æ®åŒ…çš„å¤„ç†é€»è¾‘ã€‚å¯ä»¥è¯´ï¼Œopenflowçš„è¿™ç§å¯æ‰©å±•æ€§éå¸¸å·®çš„è®¾è®¡å¤§å¤§é˜»ç¢äº†openflowçš„æ¨å¹¿å’Œä½¿ç”¨ã€‚&lt;/p>
&lt;h2 id="æ•°æ®å¹³é¢å¯ç¼–ç¨‹ä¸p4">æ•°æ®å¹³é¢å¯ç¼–ç¨‹ä¸P4&lt;/h2>
&lt;p>æ—¢ç„¶ä¹‹å‰æåˆ°äº†openflowçš„å¼Šç«¯ï¼Œè™½ç„¶å®ç°äº†æ§åˆ¶å¹³é¢çš„å¯ç¼–ç¨‹ï¼Œä½†åœ¨æ•°æ®å¹³é¢ä»ç„¶æ˜¯ä½¿ç”¨å›ºå®šçš„openflowã€‚äºæ˜¯ï¼Œæœ€å¥½èƒ½å¤Ÿæœ‰ä¸€ç§æ–¹å¼èƒ½å¤Ÿåšåˆ°åè®®æ— å…³ï¼Œä»è€Œåœ¨æ•°æ®å¹³é¢èƒ½å¤Ÿè‡ªå·±å®šä¹‰æ•°æ®åŒ…çš„å¤„ç†é€»è¾‘ã€‚äºæ˜¯ï¼ŒP4è¯­è¨€åº”è¿è€Œç”Ÿã€‚&lt;/p>
&lt;p>P4æ˜¯ä¸€ç§åè®®æ— å…³çš„æ•°æ®åŒ…å¤„ç†ç¼–ç¨‹è¯­è¨€ï¼ŒP4æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åŒ¹é…å­—æ®µï¼Œåè®®è§£æè¿‡ç¨‹å’Œè½¬å‘è¿‡ç¨‹ï¼Œä»è€Œèƒ½å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„åè®®æ— å…³å¯ç¼–ç¨‹ç½‘ç»œæ•°æ®å¹³é¢ã€‚&lt;/p>
&lt;p>ä¸è¿‡ï¼ŒP4ä¸openflowçš„å®šä½å®Œå…¨ä¸åŒã€‚openflowæ˜¯ä¸€ç§å—å‘åè®®ï¼Œå®ƒæ˜¯æ§åˆ¶å¹³é¢ä¸æ•°æ®å¹³é¢æ²Ÿé€šçš„æ¡¥æ¢ã€‚è€ŒP4åˆ™æ˜¯ä¸€é—¨æ•°æ®å¹³é¢çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒå…³æ³¨çš„æ˜¯æ•°æ®å¹³é¢çš„å¼€æ”¾æ€§ï¼Œå¹¶ä¸æ¶‰åŠåˆ°æ§åˆ¶å¹³é¢ã€‚&lt;/p>
&lt;h2 id="p4çš„æŠ½è±¡è½¬å‘æ¨¡å‹">P4çš„æŠ½è±¡è½¬å‘æ¨¡å‹&lt;/h2>
&lt;p>&lt;img src="https://img1.sdnlab.com/wp-content/uploads/2018/10/v1Model.png" alt="V1Model">&lt;/p>
&lt;p>è¿™æ˜¯P4æ‰€æä¾›çš„æœ€ç®€å•æ˜“ç†è§£çš„ç¼–ç¨‹ç»“æ„ï¼ŒV1Modelã€‚ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œæ•°æ®åŒ…çš„å¤„ç†è¿‡ç¨‹åƒä¸€æ¡æµæ°´çº¿ä¸€æ ·ï¼Œå®ƒç”±5ä¸ªæ¨¡å—ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>Parserï¼šè§£æå™¨ï¼Œå¯¹æ•°æ®åŒ…æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„æ ¼å¼è¿›è¡Œè§£æï¼Œå¹¶æå–å¤´éƒ¨çš„å„ä¸ªå­—æ®µï¼Œåœ¨è¿™é‡Œå¯èƒ½ä¼šæ ¹æ®ä¸åŒçš„å¤´éƒ¨è¿›è¡ŒåŒ¹é…ã€‚æ¯”å¦‚å¦‚æœä¸‰å±‚åŒ…å¤´çš„åè®®å­—æ®µæ˜¯0x0800åˆ™æ˜¯ipæŠ¥æ–‡ï¼Œå¦‚æœæ˜¯0x0806åˆ™æ˜¯arpæŠ¥æ–‡ï¼Œåˆ™ä¼šè¿›è¡Œä¸åŒçš„å¤„ç†ã€‚&lt;/li>
&lt;li>Ingressï¼šIngressæµæ°´çº¿éƒ¨åˆ†ï¼Œæ•°æ®å¤„ç†é€»è¾‘çš„å…¥å£ã€‚&lt;/li>
&lt;li>TMï¼šTraffic Managerï¼Œåœ¨è¿™é‡Œå®šä¹‰æ ¸å¿ƒçš„å¤„ç†é€»è¾‘ï¼Œå¹¶ä¸”ä¼šå¯¹ä¸€äº›å…ƒæ•°æ®è¿›è¡Œæ›´æ–°ã€‚&lt;/li>
&lt;li>Egressï¼šEgressæµæ°´çº¿éƒ¨åˆ†ï¼Œæ•°æ®å¤„ç†é€»è¾‘çš„å‡ºå£ã€‚&lt;/li>
&lt;li>Deparserï¼šç”¨äºå¯¹æ•°æ®åŒ…è¿›è¡Œé‡ç»„ï¼Œå› ä¸ºæ•°æ®åŒ…åœ¨å¤„ç†è¿‡ç¨‹ä¸­ç»å†äº†åˆ†è§£å’Œå¤„ç†ã€‚æ‰€ä»¥æœ€åè½¬å‘çš„æ—¶å€™éœ€è¦é‡ç»„ä¸€ä¸‹ã€‚&lt;/li>
&lt;/ol>
&lt;p>P4ä¸ºæˆ‘ä»¬æä¾›äº†ä¸Šè¿°æŠ½è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ‰€æœ‰çš„äº¤æ¢æœºçš„å†…éƒ¨å¤„ç†é€»è¾‘ç†è§£ä¸ºä¸Šè¿°çš„æ¨¡å‹ï¼Œæ¯æ¬¡æ•°æ®åŒ…è¿›å…¥äº¤æ¢æœºï¼Œéƒ½ä¼šé€šè¿‡è¿™äº›ä¸€æ¡æµæ°´çº¿ã€‚ä½ è¦åšçš„åªæ˜¯å»å®šä¹‰æµæ°´çº¿ä¸Šçš„å„ä¸ªæ¨¡å—ç½¢äº†ã€‚æ‰€ä»¥ï¼ŒæŒ‰ç…§ä¸Šè¿°æ¨¡å‹ï¼ŒP4è¯­è¨€çš„ä»£ç ç»“æ„å¦‚ä¸‹:&lt;/p>
&lt;pre>&lt;code>#include &amp;lt;core.p4&amp;gt;
#include &amp;lt;v1model.p4&amp;gt;
const bit&amp;lt;16&amp;gt; TYPE_IPV4 = 0x800;
/*************************************************************************
*********************** H E A D E R S ***********************************
*************************************************************************/
typedef bit&amp;lt;9&amp;gt; egressSpec_t;
typedef bit&amp;lt;48&amp;gt; macAddr_t;
typedef bit&amp;lt;32&amp;gt; ip4Addr_t;
/*å®šä¹‰äºŒå±‚æ•°æ®åŒ…å¤´*/
header ethernet_t {
macAddr_t dstAddr;
macAddr_t srcAddr;
bit&amp;lt;16&amp;gt; etherType;
}
/*å®šä¹‰ipæ•°æ®åŒ…å¤´*/
header ipv4_t {
bit&amp;lt;4&amp;gt; version;
bit&amp;lt;4&amp;gt; ihl;
bit&amp;lt;8&amp;gt; diffserv;
bit&amp;lt;16&amp;gt; totalLen;
bit&amp;lt;16&amp;gt; identification;
bit&amp;lt;3&amp;gt; flags;
bit&amp;lt;13&amp;gt; fragOffset;
bit&amp;lt;8&amp;gt; ttl;
bit&amp;lt;8&amp;gt; protocol;
bit&amp;lt;16&amp;gt; hdrChecksum;
ip4Addr_t srcAddr;
ip4Addr_t dstAddr;
}
struct metadata {
/* empty */
}
/*å®šä¹‰äº†headersç”±äºŒå±‚å¤´éƒ¨ä¸ä¸‰å±‚å¤´éƒ¨ç»„æˆ*/
struct headers {
ethernet_t ethernet;
ipv4_t ipv4;
}
/*************************************************************************
*********************** P A R S E R ***********************************
*************************************************************************/
parser MyParser(packet_in packet,
out headers hdr,
inout metadata meta,
inout standard_metadata_t standard_metadata) {
state start {
transition parse_ethernet; //è½¬ç§»åˆ° parse_ethernetçŠ¶æ€
}
state parse_ethernet {
packet.extract(hdr.ethernet); //æå–æ•°æ®åŒ…å¤´
transition select(hdr.ethernet.etherType) {
TYPE_IPV4: parse_ipv4; //è½¬ç§»åˆ° parse_ipv4çŠ¶æ€
default: accept;
}
}
state parse_ipv4 {
packet.extract(hdr.ipv4);
transition accept; //æ ¹æ® etherType, è½¬ç§»åˆ°å…¶ä»–çŠ¶æ€ï¼Œç›´åˆ°è½¬ç§»åˆ°acceptç»“æŸ
}
}
/*************************************************************************
************ C H E C K S U M V E R I F I C A T I O N *************
*************************************************************************/
/*æ ¡éªŒå’Œçš„è®¡ç®—å¯ä»¥ç©ºç€*/
control MyVerifyChecksum(inout headers hdr, inout metadata meta) {
apply { }
}
/*************************************************************************
************** I N G R E S S P R O C E S S I N G *******************
*************************************************************************/
control MyIngress(inout headers hdr,
inout metadata meta,
inout standard_metadata_t standard_metadata) {
/*å®šä¹‰äº†ä¸¢åŒ…çš„åŠ¨ä½œ*/
action drop() {
mark_to_drop();
}
/*å®šä¹‰äº†ä¸‰å±‚è½¬å‘çš„åŠ¨ä½œ*/
action ipv4_forward(macAddr_t dstAddr, egressSpec_t port) {
standard_metadata.egress_spec = port;
hdr.ethernet.srcAddr = hdr.ethernet.dstAddr;
hdr.ethernet.dstAddr = dstAddr;
hdr.ipv4.ttl = hdr.ipv4.ttl - 1;
}
/*å®šä¹‰table ipv4_lpm*/
table ipv4_lpm {
key = {
hdr.ipv4.dstAddr: lpm;
}
actions = {
ipv4_forward;
drop;
NoAction;
}
size = 1024;
default_action = drop();
}
//ä¸Šè¿°éƒ½æ˜¯å£°æ˜å®šä¹‰è¿‡ç¨‹ï¼Œè¿™é‡Œæ˜¯çœŸæ­£çš„æ•°æ®å¤„ç†é€»è¾‘
apply {
if (hdr.ipv4.isValid()) {
ipv4_lpm.apply();
}
}
}
/*************************************************************************
**************** E G R E S S P R O C E S S I N G *******************
*************************************************************************/
control MyEgress(inout headers hdr,
inout metadata meta,
inout standard_metadata_t standard_metadata) {
apply { }
}
/*************************************************************************
************* C H E C K S U M C O M P U T A T I O N **************
*************************************************************************/
/*æ ¡éªŒå’Œçš„è®¡ç®—éƒ¨åˆ†ï¼Œå¯ä»¥çœç•¥*/
control MyComputeChecksum(inout headers hdr, inout metadata meta) {
apply {
update_checksum(
hdr.ipv4.isValid(),
{ hdr.ipv4.version,
hdr.ipv4.ihl,
hdr.ipv4.diffserv,
hdr.ipv4.totalLen,
hdr.ipv4.identification,
hdr.ipv4.flags,
hdr.ipv4.fragOffset,
hdr.ipv4.ttl,
hdr.ipv4.protocol,
hdr.ipv4.srcAddr,
hdr.ipv4.dstAddr },
hdr.ipv4.hdrChecksum,
HashAlgorithm.csum16);
}
}
/*************************************************************************
*********************** D E P A R S E R *******************************
*************************************************************************/
/*æ•°æ®åŒ…çš„é‡ç»„é˜¶æ®µ*/
control MyDeparser(packet_out packet, in headers hdr) {
apply {
packet.emit(hdr.ethernet);
packet.emit(hdr.ipv4);
}
}
/*************************************************************************
*********************** S W I T C H *******************************
*************************************************************************/
V1Switch(
MyParser(),
MyVerifyChecksum(),
MyIngress(),
MyEgress(),
MyComputeChecksum(),
MyDeparser()
) main;
&lt;/code>&lt;/pre>&lt;p>è¿™ä¸ªç®€å•çš„P4è¯­è¨€ç¨‹åºå®šä¹‰äº†ä¸€ä¸ªä¸‰å±‚æ•°æ®åŒ…çš„å¤„ç†æµç¨‹ã€‚è¯¥ç¨‹åºçš„ä¸»å‡½æ•°å…¥å£åœ¨æœ€ä¸‹æ–¹çš„mainå‡½æ•°ï¼Œåœ¨è¿™é‡Œå®šä¹‰äº†ä¸€æ¡å®Œæ•´çš„æ•°æ®å¤„ç†æµæ°´çº¿ã€‚å…ˆæ˜¯å®šä¹‰Parserï¼Œåè®¡ç®—æ ¡éªŒå’Œï¼Œå†ç»è¿‡Ingresså’ŒEgresså¯¹æ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä¹‹åè®¡ç®—æ ¡éªŒå’Œï¼Œå†å°†æ•°æ®åŒ…é‡ç»„å°±å®Œæˆäº†ä¸€æ¬¡æ•°æ®è½¬å‘ã€‚&lt;/p>
&lt;p>P4ç¨‹åºçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯æ•°æ®å¤´éƒ¨çš„å®šä¹‰ä»¥åŠIngressä¸­å¯¹æ•°æ®åŒ…çš„å¤„ç†ã€‚åœ¨æ•°æ®å¤´éƒ¨çš„å®šä¹‰ä¸­ï¼Œå¯ä»¥å¾ˆæ˜ç¡®çœ‹åˆ°å®šä¹‰äº†äºŒå±‚ä»¥å¤ªç½‘åŒ…å¤´ä»¥åŠIPåŒ…å¤´è¿™ä¸¤ç§æ•°æ®æ ¼å¼ã€‚å½“ç„¶å¦‚æœä½ éœ€è¦å®ç°æ›´åŠ å¤æ‚çš„åº”ç”¨ï¼Œä½ å¯ä»¥å®šä¹‰æ›´å¤šçš„æ•°æ®åŒ…å¤´ä¾‹å¦‚MPLSåŒ…å¤´ï¼ŒTCPåŒ…å¤´ç­‰ï¼Œç”šè‡³ä½ ä¹Ÿå¯ä»¥å®šä¹‰openflowçš„åŒ…å¤´ï¼Œä»è€Œåœ¨P4ç¨‹åºä¸­å®ç°openflowçš„æ•°æ®å¹³é¢ã€‚&lt;/p>
&lt;p>Ingressä¸­çš„æ•°æ®åŒ…å¤„ç†æ˜¯P4çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚ç¤ºä¾‹ç¨‹åºä¸­å®šä¹‰äº†è¡¨ipv4_lpmã€‚åœ¨tableä¸­å¯ä»¥å®šä¹‰åŠ¨ä½œï¼Œipv4_lpmè¡¨ä¸­çš„åŠ¨ä½œåŒ…æ‹¬ä¸‰å±‚è½¬å‘ï¼ˆipv4_forwardï¼‰ï¼Œä¸¢åŒ…ï¼ˆdropï¼‰å’ŒNoActionï¼Œé»˜è®¤åŠ¨ä½œåˆ™æ˜¯ç®€å•çš„ä¸¢åŒ…ã€‚ipv4_forwardè¿™ä¸ªactionçš„å®ç°é€»è¾‘ä¹Ÿéå¸¸æ¸…æ™°ï¼Œé¦–å…ˆä¿®æ”¹å…ƒæ•°æ®ï¼ˆmetadataï¼‰ï¼Œå°†egressçš„ç«¯å£è®¾ç½®ä¸ºå‡ºç«¯å£ã€‚ç„¶åï¼Œå°†äºŒå±‚çš„æºMACåœ°å€ä¿®æ”¹ä¸ºå½“å‰MACåœ°å€ï¼Œå°†ç›®çš„MACä¿®æ”¹ä¸ºéœ€è¦å‘é€å‡ºå»çš„ç«¯å£çš„MACåœ°å€ï¼Œä¹‹åå°†ttlå‡ä¸€ï¼Œè¿™ä¸ªé€»è¾‘ä¹Ÿä¸æˆ‘ä»¬æ‰€çŸ¥é“çš„ä¸‰å±‚è½¬å‘è¿‡ç¨‹ä¸€è‡´ã€‚&lt;/p>
&lt;p>P4è¯­è¨€è¯­æ³•ç®€å•ï¼Œç¨‹åºç»“æ„ä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼Œéå¸¸å®¹æ˜“ä¸Šæ‰‹ã€‚ä¸€æ—¦ç†Ÿæ‚‰P4ç¨‹åºçš„å·¥ä½œæ¨¡å¼ï¼Œå°†èƒ½å¤Ÿéå¸¸æ–¹ä¾¿çš„ä¸Šæ‰‹å¼€å‘ã€‚åœ¨ç½‘ä¸Šä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒä¸é”™çš„P4å­¦ä¹ èµ„æºï¼Œæ¯”å¦‚P4å®˜æ–¹çš„ç¤ºä¾‹æ•™ç¨‹ï¼Œåœ°å€æ˜¯&lt;a href="https://github.com/p4lang/tutorials">tutorials&lt;/a>ã€‚é‡Œé¢çš„åº”ç”¨åŒ…æ‹¬äº†åŸºäºP4å®ç°çš„tunnelã€è´Ÿè½½å‡è¡¡ã€æºè·¯ç”±ã€ecnç­‰ç­‰ã€‚&lt;/p>
&lt;p>P4è¯­è¨€ç›®å‰ä»ç„¶ä¿æŒç€è‰¯å¥½çš„å‘å±•åŠ¿å¤´ï¼Œä¸”è¶Šæ¥è¶Šç«çˆ†ã€‚Barefootå…¬å¸æ¨å‡ºçš„åŸºäºP4è¯­è¨€çš„èŠ¯ç‰‡ Tofino å·²ç»å¼€å§‹é€æ¸åœ¨å¸‚åœºä¸Šä½¿ç”¨ï¼Œå¸¸è§äºä¸€äº›å¤æ‚çš„äº‘ç½‘ç»œä¸­ã€‚åŸºäºæ•°æ®å¹³é¢å¯ç¼–ç¨‹æ€æƒ³çš„P4ï¼Œæ­£åœ¨æ¨åŠ¨ç€SDNé¢†åŸŸèµ°çš„è¶Šæ¥è¶Šè¿œã€‚&lt;/p></description></item><item><title>Alertmanagerçš„å‘Šè­¦æµç¨‹åˆ†æï¼ˆä¸€ï¼‰</title><link>http://yeya24.github.io/post/am-1/</link><pubDate>Sun, 24 Feb 2019 15:05:50 +0800</pubDate><guid>http://yeya24.github.io/post/am-1/</guid><description>&lt;p>è¿™ç¯‡æ–‡ç« ä¼šä»ä¸€äº›æºä»£ç çš„è§’åº¦æ¥åˆ†æalertmanagerå‘Šè­¦çš„è¿™ä¸ªæµç¨‹ï¼ŒåŸºäºç‰ˆæœ¬0.16.1ã€‚ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œåˆ†æå¯èƒ½æœ‰ä¸€äº›ä¸åˆ°ä½çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æŒ‡å‡ºã€‚ç”±äºæ¶‰åŠçš„é˜¶æ®µæ¯”è¾ƒå¤šï¼Œæˆ‘æ‰“ç®—åˆ†2ç¯‡å†™å®Œã€‚å…ˆä¸Šä¸€å¼ å®˜æ–¹çš„æ¶æ„å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="https://github.com/prometheus/alertmanager/raw/master/doc/arch.svg?sanitize=true" alt="Alertmanageræ¶æ„">&lt;/p>
&lt;p>alertmanagerçš„æ¶æ„éå¸¸æ¸…æ™°ï¼šå›¾ä¸­å·¦ä¸Šè§’çš„APIå±‚åŒ…æ‹¬ä»prometheusæ¥æ”¶åˆ°å‘Šè­¦ä»¥åŠsilenceçš„å¢åˆ æ”¹æŸ¥ã€‚æ¥æ”¶åˆ°alertå’Œsilenceä¹‹åï¼Œå„è‡ªä¿å­˜åœ¨ä¸€ä¸ªproviderå¯¹è±¡ä¸­å­˜å‚¨èµ·æ¥ã€‚åç»­ï¼ŒçœŸæ­£çš„å‘Šè­¦æµç¨‹ç”±Dispatcherå¯¹è±¡æ¥è¿›è¡Œå¤„ç†ã€‚Dispatcherå¯¹è±¡é¢ä¼šå¯¹å‘Šè­¦è¿›è¡Œåˆ†ç»„å’Œèšåˆï¼Œç„¶åæ¯ä¸€ä¸ªå‘Šè­¦ç»„ï¼ˆGroupï¼‰ä¼šä¾æ¬¡æ‰§è¡ŒNotification Pipelineï¼Œè¿™å°±æ˜¯åŸºæœ¬çš„å‘Šè­¦æµç¨‹ã€‚&lt;/p>
&lt;h2 id="dispatcher">Dispatcher&lt;/h2>
&lt;p>Dispatcherå¯¹è±¡æ˜¯å‘Šè­¦æµç¨‹çš„æ‰§è¡Œè€…ï¼Œåœ¨mainä¸­è°ƒç”¨NewDispatcheråˆå§‹åŒ–&lt;/p>
&lt;pre>&lt;code>disp = dispatch.NewDispatcher(alerts, dispatch.NewRoute(conf.Route, nil), pipeline, marker, timeoutFunc, logger)
&lt;/code>&lt;/pre>&lt;p>ä¸‹é¢æ˜¯Dispatcherç»“æ„ä½“çš„ä¸»è¦å®šä¹‰&lt;/p>
&lt;pre>&lt;code>type Dispatcher struct {
route *Route
alerts provider.Alerts
stage notify.Stage
marker types.Marker
timeout func(time.Duration) time.Duration
aggrGroups map[*Route]map[model.Fingerprint]*aggrGroup
mtx sync.RWMutex
done chan struct{}
ctx context.Context
cancel func()
logger log.Logger
}
&lt;/code>&lt;/pre>&lt;p>ç»“æ„ä½“ä¸­ï¼Œé¦–å…ˆæ˜¯routeã€‚routeæ˜¯è·¯ç”±ä¿¡æ¯ï¼Œåœ¨alertmanagerçš„é…ç½®ä¸­é…ç½®ï¼Œå½“æ”¶åˆ°å‘Šè­¦åï¼ŒåŒ¹é…è·¯ç”±ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯åŒ¹é…labelï¼‰ï¼Œç„¶åæ‰§è¡ŒæŒ‡å®šçš„æ“ä½œã€‚æ¥ä¸‹æ¥æ˜¯alertsã€‚alertsæ˜¯alertmanagerä¸­å¾…å‘é€çš„å‘Šè­¦ä¿¡æ¯storeï¼Œprometheuså‘å‡ºçš„å‘Šè­¦å°±æ˜¯è¿›å…¥è¿™ä¸ªstoreä¿å­˜ä¸‹æ¥ï¼Œç„¶ååœ¨Dispatcherä¸­è¢«æ¶ˆè´¹ã€‚stageæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸»è¦å®ç°äº†execæ–¹æ³•ï¼Œå³æµæ°´çº¿çš„æ‰§è¡ŒåŠ¨ä½œã€‚åœ¨Dispatcherä¸­ä½¿ç”¨çš„stageç»“æ„æ˜¯pipelinesï¼Œpipelinesé‡Œé¢åŒ…å«äº†å¤šä¸ªé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯æ¶æ„å›¾å³ä¾§çš„notification pipelinesã€‚å…¶æ¬¡æ˜¯markeræ¥å£ï¼Œmarkeræ¥å£å®ç°äº†ä»¥ä¸‹æ–¹æ³•ï¼Œç›¸å½“äºå®ƒæ˜¯ä¸€ä¸ªå‘Šè­¦çš„å¤„ç†è€…çš„æŠ½è±¡ï¼Œå¯¹å‘Šè­¦çŠ¶æ€è¿›è¡Œæ›´æ–°ã€‚åé¢æ˜¯aggrGroupsï¼Œåœ¨alertmanagerä¸­æœ‰å¯¹å‘Šè­¦æ ¹æ®labelsè¿›è¡Œåˆ†ç»„çš„æ¦‚å¿µï¼Œè¿™å°±æ˜¯ä¿å­˜æ¯ä¸ªç»„æ¯æ¡å‘Šè­¦çš„mapç¼“å­˜ã€‚&lt;/p>
&lt;pre>&lt;code>type Marker interface {
SetActive(alert model.Fingerprint)
SetInhibited(alert model.Fingerprint, ids ...string)
SetSilenced(alert model.Fingerprint, ids ...string)
Count(...AlertState) int
Status(model.Fingerprint) AlertStatus
Delete(model.Fingerprint)
Unprocessed(model.Fingerprint) bool
Active(model.Fingerprint) bool
Silenced(model.Fingerprint) ([]string, bool)
Inhibited(model.Fingerprint) ([]string, bool)
}
&lt;/code>&lt;/pre>&lt;p>ä¸‹é¢çœ‹ä¸‹Dispatcherçš„ run æ–¹æ³•&lt;/p>
&lt;pre>&lt;code>func (d *Dispatcher) run(it provider.AlertIterator) {
cleanup := time.NewTicker(30 * time.Second)
defer cleanup.Stop()
defer it.Close()
for {
select {
case alert, ok := &amp;lt;-it.Next():
if !ok {
// Iterator exhausted for some reason.
if err := it.Err(); err != nil {
level.Error(d.logger).Log(&amp;quot;msg&amp;quot;, &amp;quot;Error on alert update&amp;quot;, &amp;quot;err&amp;quot;, err)
}
return
}
level.Debug(d.logger).Log(&amp;quot;msg&amp;quot;, &amp;quot;Received alert&amp;quot;, &amp;quot;alert&amp;quot;, alert)
// Log errors but keep trying.
if err := it.Err(); err != nil {
level.Error(d.logger).Log(&amp;quot;msg&amp;quot;, &amp;quot;Error on alert update&amp;quot;, &amp;quot;err&amp;quot;, err)
continue
}
for _, r := range d.route.Match(alert.Labels) {
d.processAlert(alert, r)
}
case &amp;lt;-cleanup.C:
d.mtx.Lock()
for _, groups := range d.aggrGroups {
for _, ag := range groups {
if ag.empty() {
ag.stop()
delete(groups, ag.fingerprint())
}
}
}
d.mtx.Unlock()
case &amp;lt;-d.ctx.Done():
return
}
}
}
&lt;/code>&lt;/pre>&lt;p>itå¯¹è±¡æ˜¯ä¸€ä¸ªalertsçš„è¿­ä»£å™¨ï¼Œå®ƒçš„Next()æ–¹æ³•æ˜¯ä¸€ä¸ªchannelï¼Œä»é‡Œé¢æ¶ˆè´¹åˆ°alertã€‚æ•´ä¸ªrunæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘å¾ˆç®€å•ï¼Œä»it.Next()è¿™ä¸ªchannelé‡Œé¢æ¶ˆè´¹åˆ°alertä¹‹åï¼ŒæŸ¥çœ‹æ˜¯å¦ä¸æ‰€é…ç½®çš„è·¯ç”±åŒ¹é…ï¼Œå¦‚æœåŒ¹é…çš„è¯ï¼Œè¿›å…¥alertçš„å¤„ç†æ–¹æ³•processAlertã€‚&lt;/p>
&lt;pre>&lt;code>func (d *Dispatcher) processAlert(alert *types.Alert, route *Route) {
groupLabels := getGroupLabels(alert, route)
fp := groupLabels.Fingerprint()
d.mtx.Lock()
defer d.mtx.Unlock()
group, ok := d.aggrGroups[route]
if !ok {
group = map[model.Fingerprint]*aggrGroup{}
d.aggrGroups[route] = group
}
// If the group does not exist, create it.
ag, ok := group[fp]
if !ok {
ag = newAggrGroup(d.ctx, groupLabels, route, d.timeout, d.logger)
group[fp] = ag
go ag.run(func(ctx context.Context, alerts ...*types.Alert) bool {
_, _, err := d.stage.Exec(ctx, d.logger, alerts...)
if err != nil {
level.Error(d.logger).Log(&amp;quot;msg&amp;quot;, &amp;quot;Notify for alerts failed&amp;quot;, &amp;quot;num_alerts&amp;quot;, len(alerts), &amp;quot;err&amp;quot;, err)
}
return err == nil
})
}
ag.insert(alert)
}
&lt;/code>&lt;/pre>&lt;p>è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘ä¹Ÿæ˜¯éå¸¸çš„æ¸…æ¥šã€‚åœ¨è¿™é‡Œå°±æ˜¯å…ˆæ‹¿å‡ºgroupLabelï¼ŒæŸ¥çœ‹è¿™ä¸ªlabelsçš„hashæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºä¸€ä¸ªaggrGroupã€‚æ¥ä¸‹æ¥ï¼Œæ‰§è¡Œstageçš„Execæ–¹æ³•ã€‚è‡³æ­¤ï¼ŒDispatcherçš„å¤„ç†æµç¨‹ç»“æŸï¼Œå·²ç»è¿›å…¥äº†notification pipelinesçš„é˜¶æ®µã€‚&lt;/p>
&lt;h2 id="pipelines">pipelines&lt;/h2>
&lt;p>å…ˆçœ‹çœ‹pipelinesçš„åˆ›å»ºï¼Œpipelineså°±æ˜¯RoutingStageå¯¹è±¡ï¼ŒRoutingStageæ˜¯ä¸€ä¸ªmapï¼Œå®ƒçš„keyæ˜¯æ¯ä¸€ä¸ªreceiverçš„åå­—ï¼Œvalueæ˜¯ä¸€ä¸ªmultistageå¯¹è±¡ã€‚åœ¨æ¯ä¸ªmultistageä¸­ï¼Œå¯ä»¥çœ‹åˆ°éƒ½ä¼šåŒ…æ‹¬è¿™ä¹ˆå‡ ä¸ªé˜¶æ®µï¼ŒGossipSettleStageã€InhibitStageã€SilenceStageï¼Œåé¢çš„é˜¶æ®µç”±createStageå‡½æ•°åˆ›å»ºï¼ŒcreateStageè¿”å›ä¸€ä¸ªFanoutStageï¼ŒFanoutStageä¸­ä¸ºæ¯ä¸€ä¸ªreceiveréƒ½åˆ›å»ºäº†WaitStageã€DedupStageã€RetryStageã€SetNotifierStageï¼Œå¯ä»¥ å‘ç°è¿™éƒ½å’Œä¸Šé¢çš„æ¶æ„å›¾æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚&lt;/p>
&lt;pre>&lt;code>func BuildPipeline(
confs []*config.Receiver,
tmpl *template.Template,
wait func() time.Duration,
muter types.Muter,
silences *silence.Silences,
notificationLog NotificationLæ‰§è¡Œæ—¶éƒ½ä¼šè·‘ä¸€ä¸ªGoroutineã€‚og,
marker types.Marker,
peer *cluster.Peer,
logger log.Logger,
) RoutingStage {
rs := RoutingStage{}
ms := NewGossipSettleStage(peer)
is := NewInhibitStage(muter)
ss := NewSilenceStage(silences, marker)
for _, rc := range confs {
rs[rc.Name] = MultiStage{ms, is, ss, createStage(rc, tmpl, wait, notificationLog, logger)}
}
return rs
}
func createStage(rc *config.Receiver, tmpl *template.Template, wait func() time.Duration, notificationLog NotificationLog, logger log.Logger) Stage {
var fs FanoutStage
for _, i := range BuildReceiverIntegrations(rc, tmpl, logger) {
recv := &amp;amp;nflogpb.Receiver{
GroupName: rc.Name,
Integration: i.name,
Idx: uint32(i.idx),
}
var s MultiStage
s = append(s, NewWaitStage(wait))
s = append(s, NewDedupStage(i, notificationLog, recv))
s = append(s, NewRetryStage(i, rc.Name))
s = append(s, NewSetNotifiesStage(notificationLog, recv))
fs = append(fs, s)
}
return fs
}
&lt;/code>&lt;/pre>&lt;p>æ‰€æœ‰çš„å°é˜¶æ®µéƒ½è¢«åŒ…è£…åœ¨MultiStageå’ŒFanoutStageä¸­ï¼Œå…ˆæ¥çœ‹çœ‹å®ƒä»¬çš„execæ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ã€‚åœ¨MultiStageä¸­ï¼Œexecå¾ˆç®€å•ï¼Œéå†è‡ªèº«çš„Stageï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªé˜¶æ®µå„è‡ªçš„execæ–¹æ³•ï¼Œæ ¹æ®ä¹‹å‰æ‰€è¯´pipelinesä¸­çš„MultiStageä¸­ï¼Œä¿å­˜äº†4ä¸ªé˜¶æ®µï¼ŒGossipSettleã€Inhibitã€Silenceã€FanoutStageï¼Œè¿™å››ä¸ªé˜¶æ®µä¼šä¾æ¬¡è°ƒç”¨execæ–¹æ³•ã€‚åé¢çœ‹çœ‹FanoutStageï¼Œå®ƒçš„ç±»å‹å…¶å®ä¸MultiStageç›¸åŒï¼Œä¸åŒçš„æ˜¯å®ƒçš„æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯é€šè¿‡ä¸€ä¸ªGoroutineæ¥æ‰§è¡Œã€‚å…¶å®ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼ŒGossipSettleã€Inhibitã€Silenceè¿™å‡ ä¸ªé˜¶æ®µå±äºå‘é€å‰çš„å‡†å¤‡å·¥ä½œï¼Œå¼€å¯Gossipï¼Œç¦æ­¢æŸäº›è­¦æŠ¥ä»¥åŠæ²‰é»˜æŸäº›è­¦æŠ¥ï¼Œåé¢çš„å‡ ä¸ªé˜¶æ®µæ‰æ˜¯çœŸæ­£å‘é€è­¦æŠ¥çš„æµç¨‹ã€‚åŒ…æ‹¬äº†Waitã€Dedupã€Retryä»¥åŠSetNotifyã€‚&lt;/p>
&lt;pre>&lt;code>type MultiStage []Stage
func (ms MultiStage) Exec(ctx context.Context, l log.Logger, alerts ...*types.Alert) (context.Context, []*types.Alert, error) {
var err error
for _, s := range ms {
if len(alerts) == 0 {
return ctx, nil, nil
}
ctx, alerts, err = s.Exec(ctx, l, alerts...)
if err != nil {
return ctx, nil, err
}
}
return ctx, alerts, nil
}
type FanoutStage []Stage
func (fs FanoutStage) Exec(ctx context.Context, l log.Logger, alerts ...*types.Alert) (context.Context, []*types.Alert, error) {
var (
wg sync.WaitGroup
me types.MultiError
)
wg.Add(len(fs))
for _, s := range fs {
go func(s Stage) {
if _, _, err := s.Exec(ctx, l, alerts...); err != nil {
me.Add(err)
level.Error(l).Log(&amp;quot;msg&amp;quot;, &amp;quot;Error on notify&amp;quot;, &amp;quot;err&amp;quot;, err)
}
wg.Done()
}(s)
}
wg.Wait()
if me.Len() &amp;gt; 0 {
return ctx, alerts, &amp;amp;me
}
return ctx, alerts, nil
}
&lt;/code>&lt;/pre>&lt;h2 id="gossipsettlestage">GossipSettleStage&lt;/h2>
&lt;p>GossipSettleæ˜¯ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œå¾ˆç®€å•ï¼Œè¿™ä¸ªé˜¶æ®µçš„ä¸»è¦ä½œç”¨å°±æ˜¯æ‰§è¡Œ n.peer.WaitReadyæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸alertmanagerçš„é«˜å¯ç”¨æœ‰å…³ï¼Œå¯¹äºæ¯ä¸€ä¸ªpeeræœ‰ä¸€ä¸ªreadyChannelï¼Œå½“æŸä¸€ä¸ªpeerå¤„äºunReadyçŠ¶æ€ï¼Œå°±ä¸€ç›´é˜»å¡ï¼Œreadyä¹‹åå°±è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ&lt;/p>
&lt;pre>&lt;code>type GossipSettleStage struct {
peer *cluster.Peer
}
func NewGossipSettleStage(p *cluster.Peer) *GossipSettleStage {
return &amp;amp;GossipSettleStage{peer: p}
}
func (n *GossipSettleStage) Exec(ctx context.Context, l log.Logger, alerts ...*types.Alert) (context.Context, []*types.Alert, error) {
if n.peer != nil {
n.peer.WaitReady()
}
return ctx, alerts, nil
}
&lt;/code>&lt;/pre>&lt;h2 id="inhibitstage">InhibitStage&lt;/h2>
&lt;p>ä¸‹ä¸€ä¸ªé˜¶æ®µæ˜¯InhibitStageï¼Œé¡¾åæ€ä¹‰ï¼Œå¯¹å‘Šè­¦æ‰§è¡ŒæŠ‘åˆ¶ã€‚æŠ‘åˆ¶åœ¨alertmanagerä¸­çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œæ»¡è¶³æŸäº›labelçš„æ¡ä»¶åˆ™æŠ‘åˆ¶è¯¥å‘Šè­¦ã€‚ä¸‹é¢çš„å®ç°ä¸­æ˜¯å¯¹alertsè¿›è¡Œéå†ï¼Œå¦‚æœä¸æ»¡è¶³æŠ‘åˆ¶çš„åŒ¹é…è§„åˆ™ï¼Œåˆ™åŠ å…¥filtered ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼›è€ŒåŒ¹é…ä¸Šçš„ç›¸å½“äºè¢«ä¸¢å¼ƒï¼Œä¸è¢«å¤„ç†&lt;/p>
&lt;pre>&lt;code>// InhibitStage filters alerts through an inhibition muter.
type InhibitStage struct {
muter types.Muter
}
func NewInhibitStage(m types.Muter) *InhibitStage {
return &amp;amp;InhibitStage{muter: m}
}
func (n *InhibitStage) Exec(ctx context.Context, l log.Logger, alerts ...*types.Alert) (context.Context, []*types.Alert, error) {
var filtered []*types.Alert
for _, a := range alerts {
if !n.muter.Mutes(a.Labels) {
filtered = append(filtered, a)
}
}
return ctx, filtered, nil
}
&lt;/code>&lt;/pre>&lt;h3 id="silencestage">SilenceStage&lt;/h3>
&lt;p>Silenceé˜¶æ®µæ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹å‘Šè­¦æ‰§è¡Œé™é»˜å¤„ç†ã€‚silenceè¿™ä¸ªä¸œè¥¿æ¯”è¾ƒå¤æ‚ï¼Œä¸inhibitä¸åŒï¼Œinhibitæ˜¯åœ¨alertmanagerä¸­çš„é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œåœ¨3ä¸ªAMç»„æˆçš„é›†ç¾¤ä¸­ï¼Œæ˜¯å…è®¸ä¸åŒçš„AMæœ‰ä¸åŒçš„inhibité…ç½®ã€‚è€Œsilenceåˆ™æ˜¯é€šè¿‡AMçš„APIè¿›è¡Œåˆ›å»ºåˆ é™¤ã€‚åœ¨é«˜å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œæ€»ä¸èƒ½æŸä¸ªAMçš„æŸæ¡å‘Šè­¦è¢«silenceæ‰äº†ï¼Œè€Œå¦å¤–ä¸¤ä¸ªAMç”±äºæœ¬èº«æ²¡æœ‰åˆ›å»ºsilenceï¼Œå°±æŠŠå‘Šè­¦å‘é€å‡ºå»äº†ï¼Œè¿™å°±æ— æ³•èµ·åˆ°é«˜å¯ç”¨çš„ä½œç”¨ã€‚æ‰€ä»¥silenceä¿¡æ¯ä¸€æ ·ä¼šé€šè¿‡gossipçš„æ¶ˆæ¯åœ¨AMé›†ç¾¤ä¹‹é—´è¿›è¡ŒåŒæ­¥ã€‚ç”±äºgossipæ˜¯ä¸€ä¸ªæœ€ç»ˆä¸€è‡´æ€§åè®®ï¼Œæ‰€ä»¥è‚¯å®šåœ¨ä¸­é—´ä¼šå‡ºç°æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åœ¨å‘é€silenceçš„æ—¶å€™æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚&lt;/p>
&lt;pre>&lt;code>// SilenceStage filters alerts through a silence muter.
type SilenceStage struct {
silences *silence.Silences
marker types.Marker
}
func NewSilenceStage(s *silence.Silences, mk types.Marker) *SilenceStage {
return &amp;amp;SilenceStage{
silences: s,
marker: mk,
}
}
func (n *SilenceStage) Exec(ctx context.Context, l log.Logger, alerts ...*types.Alert) (context.Context, []*types.Alert, error) {
var filtered []*types.Alert
for _, a := range alerts {
sils, err := n.silences.Query(
silence.QState(types.SilenceStateActive),
silence.QMatches(a.Labels),
)
if err != nil {
level.Error(l).Log(&amp;quot;msg&amp;quot;, &amp;quot;Querying silences failed&amp;quot;, &amp;quot;err&amp;quot;, err)
}
if len(sils) == 0 {
filtered = append(filtered, a)
n.marker.SetSilenced(a.Labels.Fingerprint())
} else {
ids := make([]string, len(sils))
for i, s := range sils {
ids[i] = s.Id
}
n.marker.SetSilenced(a.Labels.Fingerprint(), ids...)
}
}
return ctx, filtered, nil
}
&lt;/code>&lt;/pre>&lt;p>é¦–å…ˆéå†æ‰€æœ‰çš„alertsï¼Œæ ¹æ®æ¯æ¡å‘Šè­¦ï¼ŒæŸ¥è¯¢silencesçš„storeä¸­æ˜¯å¦æœ‰ç›®å‰çŠ¶æ€æ˜¯activeï¼ˆå³æ²¡æœ‰è¿‡æœŸçš„ï¼‰ï¼Œä¸”labelsä¸è¯¥å‘Šè­¦åŒ¹é…çš„silenceï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆé€šè¿‡markerçš„SetSilencedæ–¹æ³•å°†æŒ‡å®šlabelsçš„å‘Šè­¦è®¾ç½®ä¸ºsilencedçŠ¶æ€ã€‚æ–¹æ³•çš„å…³é”®å°±åœ¨äºsilencesçš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œé‚£å°±çœ‹çœ‹silences.Queryè¿™ä¸ªæ–¹æ³•&lt;/p>
&lt;pre>&lt;code>func (s *Silences) Query(params ...QueryParam) ([]*pb.Silence, error) {
start := time.Now()
s.metrics.queriesTotal.Inc()
sils, err := func() ([]*pb.Silence, error) {
q := &amp;amp;query{}
for _, p := range params {
if err := p(q); err != nil {
return nil, err
}
}
return s.query(q, s.now())
}()
if err != nil {
s.metrics.queryErrorsTotal.Inc()
}
s.metrics.queryDuration.Observe(time.Since(start).Seconds())
return sils, err
}
func (s *Silences) query(q *query, now time.Time) ([]*pb.Silence, error) {
// If we have an ID constraint, all silences are our base set.
// This and the use of post-filter functions is the
// the trivial solution for now.
var res []*pb.Silence
s.mtx.Lock()
defer s.mtx.Unlock()
if q.ids != nil {
for _, id := range q.ids {
if s, ok := s.st[id]; ok {
res = append(res, s.Silence)
}
}
} else {
for _, sil := range s.st {
res = append(res, sil.Silence)
}
}
var resf []*pb.Silence
for _, sil := range res {
remove := false
for _, f := range q.filters {
ok, err := f(sil, s, now)
if err != nil {
return nil, err
}
if !ok {
remove = true
break
}
}
if !remove {
resf = append(resf, cloneSilence(sil))
}
}
return resf, nil
}
&lt;/code>&lt;/pre>&lt;p>è¿™ä¸¤ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œsilences.Queryè¿™ä¸ªæ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯queryæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹queryæ–¹æ³•ã€‚queryæ–¹æ³•ä¸­ï¼Œé¦–å…ˆçœ‹å‚æ•°çš„queryé‡Œé¢æœ‰æ²¡æœ‰å¸¦ä¸Šidé™åˆ¶ï¼Œå¦‚æœæœ‰æŒ‡å®šidï¼Œå°±ä»s.stè¿™ä¸ªä¿å­˜äº†å½“å‰æ‰€æœ‰silenceçš„mapæ‰¾å‡ºæŒ‡å®šidçš„silenceã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™å°†mapé‡Œé¢çš„æ‰€æœ‰silenceåŠ å…¥resè¿™ä¸ªåˆ‡ç‰‡ä¸­ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è‚¯å®šæ˜¯æ²¡æœ‰æŒ‡å®šidï¼Œæ‰€ä»¥ä¼šå…ˆå¾—åˆ°æ‰€æœ‰çš„silenceã€‚ä¹‹åå¯¹resè¿™ä¸ªåˆ‡ç‰‡è¿›è¡Œéå†ï¼Œæ‰§è¡Œfilterè¿›è¡Œè¿‡æ»¤ã€‚æ‰€è°“çš„è¿‡æ»¤å³æ˜¯æ¯”è¾ƒä¹‹å‰è°ƒç”¨Queryæ—¶å€™æŒ‡å®šçš„ä¸¤ä¸ªå‚æ•°ï¼šçŠ¶æ€ä¸ºactiveï¼Œä¸”èƒ½åŒ¹é…ä¸Šè­¦æŠ¥çš„æ ‡ç­¾ã€‚é€šè¿‡filterè¿‡æ»¤ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™removeæ ‡å¿—ä¸ºtrueï¼Œå¹¶breaké€€å‡ºï¼›å¦‚æœä¸€ç›´éƒ½æ»¡è¶³ï¼Œåˆ™å°†è¿™ä¸ªsilenceå¯¹è±¡åŠ å…¥åˆ°resfè¿™ä¸ªåˆ‡ç‰‡ä¸­ï¼Œè¿”å›å›å»ã€‚å¯ä»¥çœ‹å‡ºï¼Œåœ¨ä¸Šè¿°silenceçš„æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œæ˜¯æœ‰å¯èƒ½å‡ºç°å¤šä¸ªAMå®ä¾‹ä¸­silenceçŠ¶æ€ä¸åŒçš„æƒ…å†µçš„ï¼Œå¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚&lt;/p>
&lt;pre>&lt;code>sils, err := n.silences.Query(
silence.QState(types.SilenceStateActive),
silence.QMatches(a.Labels),
)
&lt;/code>&lt;/pre></description></item><item><title>About</title><link>http://yeya24.github.io/about/</link><pubDate>Sun, 11 Nov 2018 16:42:45 +0800</pubDate><guid>http://yeya24.github.io/about/</guid><description>&lt;p>å¤§å­¦ç”Ÿä¸€æš~&lt;/p></description></item><item><title>Iptableså­¦ä¹ ä¸è®°å½•</title><link>http://yeya24.github.io/post/iptables-study/</link><pubDate>Sun, 11 Nov 2018 16:30:03 +0800</pubDate><guid>http://yeya24.github.io/post/iptables-study/</guid><description>&lt;h2 id="iptableså­¦ä¹ ä¸è®°å½•">iptableså­¦ä¹ ä¸è®°å½•&lt;/h2>
&lt;ol>
&lt;li>åˆ—å‡ºè¡¨ä¸­çš„è§„åˆ™&lt;/li>
&lt;/ol>
&lt;pre>&lt;code>iptables -L
&lt;/code>&lt;/pre>&lt;p>ç­‰åŒäº iptables &amp;ndash;list åˆ—å‡ºæŒ‡å®štableçš„æ‰€æœ‰è§„åˆ™ï¼Œå¦‚æœä¸ä½¿ç”¨-t å‚æ•°æŒ‡å®šå¯¹åº”çš„è¡¨ï¼Œåˆ™é»˜è®¤ä¸ºfilterè¡¨ï¼Œ filterè¡¨ä¸­åŒ…æ‹¬ INPUTã€ OUTPUTã€FORWARD ä¸‰æ¡ chain
å¸¸ç”¨å‚æ•°ï¼š&lt;/p>
&lt;pre>&lt;code>iptables -vnL -t [è¡¨å] --line-numbers
&lt;/code>&lt;/pre>&lt;p>è¡¨åä¸º natã€filter æˆ–æ˜¯ mangle ä¸‰å¼ è¡¨ä¸­çš„ä¸€å¼ ï¼Œå¦‚æœä¸å¡«é»˜è®¤æ˜¯filterè¡¨
-v ä»£è¡¨å†—ä½™è¾“å‡ºï¼Œ å¸¦ä¸Šè¿™ä¸ªå‚æ•°èƒ½å¤Ÿçœ‹åˆ°å¯¹åº”ruleåŒ¹é…åˆ°çš„æ•°æ®åŒ…æ•°é‡ (pkts) ä»¥åŠå­—èŠ‚æ•°(bytes)
-n ä»£è¡¨èƒ½å¤Ÿå…¨éƒ¨ä»¥æ•°å­—çš„æ–¹å¼è¾“å‡º ip åœ°å€ä»¥åŠç«¯å£å·ï¼Œ å¦‚æœä¸åŠ è¿™ä¸ªå‚æ•°ï¼Œ0.0.0.0/0 ä¼šè¢«é»˜è®¤è§£ææˆ anywhere
&amp;ndash;line-numbers èƒ½å¤Ÿåœ¨æ‰“å°å‡ºè§„åˆ™çš„æ—¶å€™å±•ç¤ºå‡ºå¯¹åº”çš„è¡Œå·&lt;/p>
&lt;ol start="2">
&lt;li>åˆ—å‡ºæŒ‡å®šè¡¨çš„æŒ‡å®šé“¾çš„è§„åˆ™&lt;/li>
&lt;/ol>
&lt;pre>&lt;code>iptables -t [è¡¨å] -vnL [é“¾å]
&lt;/code>&lt;/pre>&lt;ol start="3">
&lt;li>ä½¿ç”¨iptables-save&lt;/li>
&lt;/ol>
&lt;pre>&lt;code>iptables-save -t [è¡¨å]
&lt;/code>&lt;/pre>&lt;p>ä½¿ç”¨ iptables-save ä¹Ÿèƒ½å¤ŸæŸ¥çœ‹è§„åˆ™ï¼Œ ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤å‘½ä»¤å°†è§„åˆ™å¯¼å‡ºæˆä¸€ä¸ªæ–‡ä»¶&lt;/p>
&lt;pre>&lt;code>iptables-save &amp;gt; [æ–‡ä»¶å]
&lt;/code>&lt;/pre></description></item></channel></rss>